name: åŒæ­¥mainåˆ°devæµ‹è¯•åˆ†æ”¯

on:
  # åªå…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: write
  issues: write
  pull-requests: write
  workflows: write

env:
  BACKUP_DIR: '.sync-backups'
  TEMP_DIR: '.sync-temp'
  BACKUP_RETAIN_DAYS: 7

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: é…ç½®Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          echo "âœ… Gité…ç½®å®Œæˆ"
      
      - name: ç¬¬ä¸€æ­¥ - åˆå¹¶mainåˆ†æ”¯
        id: merge
        run: |
          echo "ğŸš€ å¼€å§‹åŒæ­¥mainåˆ†æ”¯åˆ°custom-devåˆ†æ”¯..."
          
          echo "ğŸ“¥ è·å–æœ€æ–°ä»£ç ..."
          git fetch origin
          git fetch origin main:main
          
          echo "ğŸ” æ£€æŸ¥custom-devåˆ†æ”¯çŠ¶æ€..."
          if ! git show-ref --verify --quiet refs/remotes/origin/custom-dev; then
            echo "âš ï¸ custom-devåˆ†æ”¯ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
            git checkout -b custom-dev
            echo "âœ… custom-devåˆ†æ”¯åˆ›å»ºæˆåŠŸ"
          else
            echo "âœ… åˆ‡æ¢åˆ°å·²å­˜åœ¨çš„custom-devåˆ†æ”¯"
            git checkout custom-dev
            echo "ğŸ”„ é‡ç½®åˆ†æ”¯åˆ°æœ€æ–°çŠ¶æ€"
            git reset --hard origin/custom-dev
          fi

          echo "ğŸ§¹ æ¸…ç†å¯èƒ½å­˜åœ¨çš„åˆå¹¶çŠ¶æ€..."
          git merge --abort || true

          echo "ğŸ”„ å°è¯•åˆå¹¶mainåˆ†æ”¯ï¼Œæ’é™¤workflowæ–‡ä»¶..."
          # ä¿å­˜å½“å‰çš„workflowæ–‡ä»¶
          mkdir -p .workflow-backup
          cp -r .github/workflows/* .workflow-backup/
          
          # å°è¯•åˆå¹¶ï¼Œä½†æ’é™¤workflowæ–‡ä»¶
          if git merge main --no-commit; then
            # æ¢å¤åŸæœ‰çš„workflowæ–‡ä»¶
            cp -r .workflow-backup/* .github/workflows/
            rm -rf .workflow-backup
            
            echo "âœ… åˆå¹¶æˆåŠŸ"
            git add -A
            git commit -m "åŒæ­¥mainåˆ†æ”¯ä»£ç ï¼ˆä¿ç•™åŸæœ‰workflowé…ç½®ï¼‰"
            git push --force origin custom-dev
            exit 0
          else
            # åˆå¹¶å¤±è´¥æ—¶ä¹Ÿè¦æ¢å¤workflowæ–‡ä»¶
            cp -r .workflow-backup/* .github/workflows/
            rm -rf .workflow-backup
            echo "åˆå¹¶å‘ç”Ÿå†²çªï¼Œè¿›å…¥ç¬¬äºŒæ­¥"
            exit 1
          fi

      - name: ç¬¬äºŒæ­¥ - å°è¯•è‡ªåŠ¨åˆå¹¶
        if: failure() && steps.merge.outcome == 'failure'
        id: auto_merge
        run: |
          echo "ğŸ”„ å¼€å§‹å°è¯•è‡ªåŠ¨è§£å†³å†²çª..."
          
          echo "ğŸ§¹ æ¸…ç†å½“å‰åˆå¹¶çŠ¶æ€..."
          git merge --abort || true

          echo "ğŸ”§ å®‰è£…å¿…è¦å·¥å…·..."
          sudo apt-get update
          sudo apt-get install -y diffutils

          echo "ğŸ”„ é‡æ–°å°è¯•åˆå¹¶ä»¥æ£€æµ‹å†²çª..."
          git merge main || true

          echo "ğŸ” æ£€æŸ¥å†²çªæ–‡ä»¶..."
          CONFLICT_FILES=$(git diff --name-only --diff-filter=U || true)
          if [ -z "$CONFLICT_FILES" ]; then
            echo "âŒ åˆå¹¶å¤±è´¥ä½†æ²¡æœ‰æ£€æµ‹åˆ°å†²çªæ–‡ä»¶ï¼Œå¯èƒ½æ˜¯å…¶ä»–é”™è¯¯"
            echo "ğŸ’¡ å½“å‰gitçŠ¶æ€ï¼š"
            git status
            exit 1
          fi

          # è¿‡æ»¤æ‰ workflow æ–‡ä»¶
          FILTERED_CONFLICT_FILES=""
          for file in $CONFLICT_FILES; do
            if [[ $file != .github/workflows/* ]]; then
              FILTERED_CONFLICT_FILES="$FILTERED_CONFLICT_FILES\n$file"
            fi
          done
          CONFLICT_FILES="$FILTERED_CONFLICT_FILES"

          echo "ğŸ“ å‘ç°ä»¥ä¸‹å†²çªæ–‡ä»¶ï¼ˆå·²æ’é™¤workflowæ–‡ä»¶ï¼‰ï¼š"
          echo "$CONFLICT_FILES"
          
          echo "CONFLICT_FILES<<EOF" >> $GITHUB_ENV
          echo "$CONFLICT_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          MERGE_SUCCESS=true
          BACKUP_FILES=""
          
          for file in $CONFLICT_FILES; do
            echo "ğŸ”„ å¤„ç†æ–‡ä»¶: $file"
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f "$file" ]; then
              echo "âš ï¸ è­¦å‘Šï¼šæ–‡ä»¶ $file ä¸å­˜åœ¨ï¼Œè·³è¿‡"
              continue
            fi
            
            echo "ğŸ“‘ è·å–æ–‡ä»¶ç‰ˆæœ¬ä¿¡æ¯..."
            BASE=$(git merge-base HEAD main)
            git show $BASE:$file > base.tmp || touch base.tmp
            git show HEAD:$file > ours.tmp || touch ours.tmp
            git show main:$file > theirs.tmp || touch theirs.tmp
            
            echo "ğŸ”„ å°è¯•ä¸‰æ–¹åˆå¹¶..."
            if diff3 -m ours.tmp base.tmp theirs.tmp > merged.tmp 2>/dev/null; then
              if ! grep -q '<<<<<<<' merged.tmp; then
                echo "âœ… æ–‡ä»¶ $file è‡ªåŠ¨åˆå¹¶æˆåŠŸ"
                mv merged.tmp "$file"
                git add "$file"
                continue
              fi
            fi
            
            echo "âš ï¸ æ–‡ä»¶ $file è‡ªåŠ¨åˆå¹¶å¤±è´¥"
            MERGE_SUCCESS=false
            
            echo "ğŸ’¾ åˆ›å»ºå¤‡ä»½æ–‡ä»¶..."
            backup_file="${file}.$(date +%Y%m%d_%H%M%S).backup"
            cp "$file" "$backup_file"
            git add "$backup_file"
            BACKUP_FILES="$BACKUP_FILES\n$backup_file"
            
            echo "ğŸ“¥ ä½¿ç”¨mainåˆ†æ”¯ç‰ˆæœ¬..."
            git checkout main -- "$file"
            git add "$file"
          done

          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -f *.tmp

          if [ "$MERGE_SUCCESS" = true ]; then
            echo "âœ… æ‰€æœ‰æ–‡ä»¶è‡ªåŠ¨åˆå¹¶æˆåŠŸ"
            git add -A
            git commit -m "åŒæ­¥mainåˆ†æ”¯ä»£ç "
            git push --force origin custom-dev
            exit 0
          else
            # æäº¤å¤‡ä»½æ–‡ä»¶å’Œmainåˆ†æ”¯çš„æ›´æ”¹
            echo "âš ï¸ éƒ¨åˆ†æ–‡ä»¶æ— æ³•è‡ªåŠ¨åˆå¹¶ï¼Œå·²åˆ›å»ºå¤‡ä»½"
            git add -A
            git commit -m "åŒæ­¥mainåˆ†æ”¯ä»£ç ï¼Œå¹¶ä¿å­˜å†²çªæ–‡ä»¶å¤‡ä»½"
            git push --force origin custom-dev
            
            echo "BACKUP_FILES<<EOF" >> $GITHUB_ENV
            echo -e "$BACKUP_FILES" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            echo "ğŸ“‹ åˆ›å»ºIssueæŠ¥å‘Šå†²çªæƒ…å†µ..."
            exit 1
          fi

      - name: ç¬¬ä¸‰æ­¥ - ä½¿ç”¨mainä»£ç å¹¶åˆ›å»ºIssue
        if: failure() && steps.auto_merge.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          script: |
            console.log('ğŸ“ æ­£åœ¨åˆ›å»ºåŒæ­¥å†²çªæŠ¥å‘Š...');
            
            const issueBody = `
            # main -> custom-dev åŒæ­¥å†²çªæŠ¥å‘Š
            
            åœ¨åŒæ­¥è¿‡ç¨‹ä¸­å‘ç°ä»¥ä¸‹æ–‡ä»¶å­˜åœ¨å†²çªï¼Œå·²è‡ªåŠ¨ä½¿ç”¨mainåˆ†æ”¯çš„ä»£ç å¹¶å¤‡ä»½åŸæ–‡ä»¶ã€‚
            
            ## å†²çªæ–‡ä»¶åˆ—è¡¨
            \`\`\`
            ${process.env.CONFLICT_FILES}
            \`\`\`
            
            ## å¤‡ä»½æ–‡ä»¶
            å·²åœ¨æ¯ä¸ªå†²çªæ–‡ä»¶çš„åŒç›®å½•ä¸‹åˆ›å»ºå¤‡ä»½æ–‡ä»¶ï¼š
            \`\`\`
            ${process.env.BACKUP_FILES}
            \`\`\`
            
            ## å¤„ç†è¯´æ˜
            1. æ‰€æœ‰å†²çªæ–‡ä»¶å·²ä½¿ç”¨mainåˆ†æ”¯çš„ç‰ˆæœ¬
            2. custom-devåˆ†æ”¯çš„åŸå§‹ä»£ç å·²åœ¨åŒç›®å½•ä¸‹å¤‡ä»½
            3. å¦‚éœ€æ¢å¤æˆ–åˆå¹¶è‡ªå®šä¹‰ä»£ç ï¼Œè¯·å‚è€ƒå¤‡ä»½æ–‡ä»¶
            
            ## æ‰‹åŠ¨å¤„ç†æ­¥éª¤
            1. æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å†…å®¹
            2. å¦‚éœ€ä¿®æ”¹ï¼Œè¯·åœ¨custom-devåˆ†æ”¯ä¸Šè¿›è¡Œæ›´æ”¹
            3. ç¡®ä¿æ›´æ”¹åçš„ä»£ç ä¸mainåˆ†æ”¯çš„æ”¹åŠ¨ä¸å†²çª
            `;
            
            console.log('ğŸ“¤ æäº¤Issue...');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ”„ main -> custom-dev åŒæ­¥å†²çªæŠ¥å‘Š',
              body: issueBody,
              labels: ['sync-conflict']
            });
            console.log('âœ… Issueåˆ›å»ºæˆåŠŸ');

      - name: Cleanup temp files
        if: always()
        run: |
          rm -rf $TEMP_DIR
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶å®Œæˆ"
      
      - name: Notify result
        run: |
          echo "âœ… åŒæ­¥æµç¨‹å·²å®Œæˆã€‚è¯·æ£€æŸ¥ custom-dev åˆ†æ”¯ï¼Œå¦‚æœ‰ .backup æ–‡ä»¶è¯·æ‰‹åŠ¨ diff å¹¶å¤„ç†ã€‚" 
