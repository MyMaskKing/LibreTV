name: åŒæ­¥mainåˆ°devæµ‹è¯•åˆ†æ”¯

on:
  # åªå…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  BACKUP_DIR: '.sync-backups'
  TEMP_DIR: '.sync-temp'
  BACKUP_RETAIN_DAYS: 7

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: é…ç½®Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          echo "âœ… Gité…ç½®å®Œæˆ"
      
      - name: ç¬¬ä¸€æ­¥ - åˆå¹¶mainåˆ†æ”¯
        id: merge
        run: |
          echo "ğŸš€ å¼€å§‹åŒæ­¥mainåˆ†æ”¯åˆ°custom-devåˆ†æ”¯..."
          
          echo "ğŸ“¥ è·å–æœ€æ–°ä»£ç ..."
          git fetch origin
          git fetch origin main:main
          
          echo "ğŸ” æ£€æŸ¥custom-devåˆ†æ”¯çŠ¶æ€..."
          if ! git show-ref --verify --quiet refs/remotes/origin/custom-dev; then
            echo "âš ï¸ custom-devåˆ†æ”¯ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
            git checkout -b custom-dev
            echo "âœ… custom-devåˆ†æ”¯åˆ›å»ºæˆåŠŸ"
          else
            echo "âœ… åˆ‡æ¢åˆ°å·²å­˜åœ¨çš„custom-devåˆ†æ”¯"
            git checkout custom-dev
            echo "ğŸ”„ é‡ç½®åˆ†æ”¯åˆ°æœ€æ–°çŠ¶æ€"
            git reset --hard origin/custom-dev
          fi

          echo "ğŸ§¹ æ¸…ç†å¯èƒ½å­˜åœ¨çš„åˆå¹¶çŠ¶æ€..."
          git merge --abort || true

          echo "ğŸ”„ å°è¯•åˆå¹¶mainåˆ†æ”¯..."
          if git merge --squash main --no-commit; then
            echo "ğŸ”„ æ’é™¤ workflow æ–‡ä»¶..."
            git restore --staged .github/workflows/
            git restore .github/workflows/
            
            echo "âœ… åˆå¹¶æˆåŠŸ"
            git add -A
            git commit -m "åŒæ­¥mainåˆ†æ”¯ä»£ç "
            git push --force origin custom-dev
            exit 0
          else
            echo "åˆå¹¶å‘ç”Ÿå†²çªï¼Œè¿›å…¥ç¬¬äºŒæ­¥"
            exit 1
          fi

      - name: ç¬¬äºŒæ­¥ - å¤‡ä»½å†²çªæ–‡ä»¶å¹¶ä½¿ç”¨mainç‰ˆæœ¬
        if: failure() && steps.merge.outcome == 'failure'
        id: auto_merge
        run: |
          echo "ğŸ”„ å¼€å§‹å¤„ç†åˆå¹¶å†²çª..."
          
          # å…ˆè·å–å†²çªæ–‡ä»¶åˆ—è¡¨
          CONFLICT_FILES=$(git status --porcelain | grep "^UU" | cut -c4-)
          
          if [ -z "$CONFLICT_FILES" ]; then
            echo "âŒ æ²¡æœ‰æ£€æµ‹åˆ°å†²çªæ–‡ä»¶ï¼Œå¯èƒ½æ˜¯å…¶ä»–é”™è¯¯"
            echo "ğŸ’¡ å½“å‰gitçŠ¶æ€ï¼š"
            git status
            exit 1
          fi

          # è¿‡æ»¤æ‰ workflow æ–‡ä»¶ï¼Œå¹¶ç¡®ä¿æ¯ä¸ªæ–‡ä»¶å•ç‹¬ä¸€è¡Œ
          FILTERED_CONFLICT_FILES=""
          while IFS= read -r file; do
            if [[ ! "$file" =~ ^\.github/workflows/ ]]; then
              FILTERED_CONFLICT_FILES="${FILTERED_CONFLICT_FILES}${file}\n"
            fi
          done <<< "$CONFLICT_FILES"
          
          # ç§»é™¤æœ€åçš„æ¢è¡Œç¬¦
          FILTERED_CONFLICT_FILES=$(echo -e "$FILTERED_CONFLICT_FILES" | sed '$ s/\\n$//')
          CONFLICT_FILES="$FILTERED_CONFLICT_FILES"

          echo "ğŸ“ å‘ç°ä»¥ä¸‹å†²çªæ–‡ä»¶ï¼ˆå·²æ’é™¤workflowæ–‡ä»¶ï¼‰ï¼š"
          echo -e "$CONFLICT_FILES"
          
          echo "CONFLICT_FILES<<EOF" >> $GITHUB_ENV
          echo -e "$CONFLICT_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          BACKUP_FILES=""
          
          # å¤„ç†æ¯ä¸ªå†²çªæ–‡ä»¶
          while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi
            
            echo "ğŸ”„ å¤„ç†æ–‡ä»¶: $file"
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f "$file" ]; then
              echo "âš ï¸ è­¦å‘Šï¼šæ–‡ä»¶ $file ä¸å­˜åœ¨ï¼Œè·³è¿‡"
              continue
            fi
            
            echo "ğŸ’¾ åˆ›å»ºå¤‡ä»½æ–‡ä»¶..."
            backup_file="${file}.$(date +%Y%m%d_%H%M%S).backup"
            cp "$file" "$backup_file" || echo "âš ï¸ æ— æ³•åˆ›å»ºå¤‡ä»½æ–‡ä»¶: $backup_file"
            
            if [ -f "$backup_file" ]; then
              echo "âœ… å¤‡ä»½æ–‡ä»¶åˆ›å»ºæˆåŠŸ: $backup_file"
              BACKUP_FILES="${BACKUP_FILES}\n$backup_file"
              
              echo "ğŸ“¥ ä½¿ç”¨mainåˆ†æ”¯ç‰ˆæœ¬..."
              git checkout main -- "$file"
              git add "$file"
            fi
          done <<< "$FILTERED_CONFLICT_FILES"

          # å…ˆæäº¤å¤‡ä»½æ–‡ä»¶
          echo "ğŸ’¾ æäº¤å¤‡ä»½æ–‡ä»¶..."
          git add -A
          git commit -m "å¤‡ä»½å†²çªæ–‡ä»¶" || true
          
          # æ¸…ç†å½“å‰çŠ¶æ€
          git reset --hard HEAD
          git clean -f -d
          
          # è·å– main åˆ†æ”¯çš„æ‰€æœ‰æ›´æ”¹
          echo "ğŸ“¥ åŒæ­¥ main åˆ†æ”¯çš„æ‰€æœ‰æ›´æ”¹..."
          git checkout main -- .
          
          # æ¢å¤ workflow æ–‡ä»¶
          git checkout custom-dev -- .github/workflows/

          # æäº¤mainåˆ†æ”¯æ›´æ”¹
          echo "âš ï¸ å·²åŒæ­¥mainåˆ†æ”¯ä»£ç å¹¶ä¿å­˜äº†å†²çªæ–‡ä»¶å¤‡ä»½"
          git add -A
          git commit -m "åŒæ­¥mainåˆ†æ”¯ä»£ç ï¼Œå¹¶ä¿å­˜å†²çªæ–‡ä»¶å¤‡ä»½"
          git push --force origin custom-dev
          
          echo "BACKUP_FILES<<EOF" >> $GITHUB_ENV
          echo -e "$BACKUP_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "ğŸ“‹ åˆ›å»ºIssueæŠ¥å‘Šå†²çªæƒ…å†µ..."
          exit 1

      - name: ç¬¬ä¸‰æ­¥ - åˆ›å»ºIssueæŠ¥å‘Š
        if: failure() && steps.auto_merge.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          script: |
            console.log('ğŸ“ æ­£åœ¨åˆ›å»ºåŒæ­¥å†²çªæŠ¥å‘Š...');
            
            const issueBody = `
            # main -> custom-dev åŒæ­¥å†²çªæŠ¥å‘Š
            
            åœ¨åŒæ­¥è¿‡ç¨‹ä¸­å‘ç°ä»¥ä¸‹æ–‡ä»¶å­˜åœ¨å†²çªï¼Œå·²è‡ªåŠ¨ä½¿ç”¨mainåˆ†æ”¯çš„ä»£ç å¹¶å¤‡ä»½åŸæ–‡ä»¶ã€‚
            
            ## å†²çªæ–‡ä»¶åˆ—è¡¨
            \`\`\`
            ${process.env.CONFLICT_FILES}
            \`\`\`
            
            ## å¤‡ä»½æ–‡ä»¶
            å·²åœ¨æ¯ä¸ªå†²çªæ–‡ä»¶çš„åŒç›®å½•ä¸‹åˆ›å»ºå¤‡ä»½æ–‡ä»¶ï¼š
            \`\`\`
            ${process.env.BACKUP_FILES}
            \`\`\`
            
            ## å¤„ç†è¯´æ˜
            1. æ‰€æœ‰å†²çªæ–‡ä»¶å·²ä½¿ç”¨mainåˆ†æ”¯çš„ç‰ˆæœ¬
            2. custom-devåˆ†æ”¯çš„åŸå§‹ä»£ç å·²åœ¨åŒç›®å½•ä¸‹å¤‡ä»½
            3. å¦‚éœ€æ¢å¤æˆ–åˆå¹¶è‡ªå®šä¹‰ä»£ç ï¼Œè¯·å‚è€ƒå¤‡ä»½æ–‡ä»¶
            
            ## æ‰‹åŠ¨å¤„ç†æ­¥éª¤
            1. æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å†…å®¹
            2. å¦‚éœ€ä¿®æ”¹ï¼Œè¯·åœ¨custom-devåˆ†æ”¯ä¸Šè¿›è¡Œæ›´æ”¹
            3. ç¡®ä¿æ›´æ”¹åçš„ä»£ç ä¸mainåˆ†æ”¯çš„æ”¹åŠ¨ä¸å†²çª
            `;
            
            console.log('ğŸ“¤ æäº¤Issue...');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ”„ main -> custom-dev åŒæ­¥å†²çªæŠ¥å‘Š',
              body: issueBody,
              labels: ['sync-conflict']
            });
            console.log('âœ… Issueåˆ›å»ºæˆåŠŸ');

      - name: Cleanup temp files
        if: always()
        run: |
          rm -rf $TEMP_DIR
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶å®Œæˆ"
      
      - name: Notify result
        run: |
          echo "âœ… åŒæ­¥æµç¨‹å·²å®Œæˆã€‚è¯·æ£€æŸ¥ custom-dev åˆ†æ”¯ï¼Œå¦‚æœ‰ .backup æ–‡ä»¶è¯·æ‰‹åŠ¨ diff å¹¶å¤„ç†ã€‚" 
