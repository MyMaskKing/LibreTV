name: åŒæ­¥mainåˆ°devæµ‹è¯•åˆ†æ”¯(åŸºäºexcludeé…ç½®)

on:
  # åªå…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  BACKUP_DIR: '.sync-backups'
  TEMP_DIR: '.sync-temp'
  EXCLUDE_FILE: 'sync-exclude.txt'
  BACKUP_RETAIN_DAYS: 7

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: é…ç½®Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          echo "âœ… Gité…ç½®å®Œæˆ"
      
      - name: åŒæ­¥mainåˆ†æ”¯åˆ°custom-dev
        run: |
          echo "ğŸš€ å¼€å§‹åŒæ­¥mainåˆ†æ”¯åˆ°custom-devåˆ†æ”¯..."
          
          # æ£€æŸ¥excludeé…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$EXCLUDE_FILE" ]; then
            echo "âŒ é”™è¯¯ï¼š$EXCLUDE_FILE æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "ğŸ“¥ è·å–æœ€æ–°ä»£ç ..."
          git fetch origin
          git fetch origin main:main
          
          echo "ğŸ” æ£€æŸ¥custom-devåˆ†æ”¯çŠ¶æ€..."
          if ! git show-ref --verify --quiet refs/remotes/origin/custom-dev; then
            echo "âš ï¸ custom-devåˆ†æ”¯ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
            git checkout -b custom-dev
            echo "âœ… custom-devåˆ†æ”¯åˆ›å»ºæˆåŠŸ"
          else
            echo "âœ… åˆ‡æ¢åˆ°å·²å­˜åœ¨çš„custom-devåˆ†æ”¯"
            git checkout custom-dev
            echo "ğŸ”„ é‡ç½®åˆ†æ”¯åˆ°æœ€æ–°çŠ¶æ€"
            git reset --hard origin/custom-dev
          fi

          echo "ğŸ§¹ æ¸…ç†å¯èƒ½å­˜åœ¨çš„åˆå¹¶çŠ¶æ€..."
          git merge --abort || true

          # è¯»å–éœ€è¦ä¿ç•™çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆæ’é™¤æ³¨é‡Šå’Œç©ºè¡Œï¼‰
          EXCLUDE_PATTERNS=$(grep -v '^#' "$EXCLUDE_FILE" | grep -v '^$')
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•å’Œå¤‡ä»½ç›®å½•
          TEMP_DIR=".sync-temp"
          BACKUP_ROOT="../backup_files"
          rm -rf "$TEMP_DIR" "$BACKUP_ROOT"
          mkdir -p "$TEMP_DIR" "$BACKUP_ROOT"
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨å¤‡ä»½æ–‡ä»¶åˆ—è¡¨
          BACKUP_FILES_LIST="/tmp/backup_files_list.txt"
          > "$BACKUP_FILES_LIST"  # æ¸…ç©ºæ–‡ä»¶
          
          # è·å–å…±åŒç¥–å…ˆ
          base=$(git merge-base main custom-dev)
          
          # å¤‡ä»½éœ€è¦ä¿ç•™çš„æ–‡ä»¶
          echo "ğŸ“¦ å¤‡ä»½éœ€è¦ä¿ç•™çš„æ–‡ä»¶..."
          while IFS= read -r pattern; do
            if [ -z "$pattern" ]; then
              continue
            fi
            
            # å¦‚æœæ˜¯ç›®å½•æ¨¡å¼ï¼ˆä»¥/ç»“å°¾ï¼‰
            if [[ "$pattern" == */ ]]; then
              if [ -d "$pattern" ]; then
                # æ£€æŸ¥ç›®å½•æ˜¯å¦æœ‰ä¿®æ”¹
                if ! git diff --quiet $base HEAD -- "$pattern"; then
                  dir_name=$(basename "$pattern")
                  backup_dir="$BACKUP_ROOT/$pattern"
                  mkdir -p "$backup_dir"
                  cp -r "$pattern"* "$backup_dir"
                  echo "$pattern" >> "$BACKUP_FILES_LIST"
                  echo "âœ… å¤‡ä»½å·²ä¿®æ”¹çš„ç›®å½•: $pattern"
                fi
              fi
            else
              # å¦‚æœæ˜¯æ–‡ä»¶
              if [ -f "$pattern" ]; then
                # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰ä¿®æ”¹
                if ! git diff --quiet $base HEAD -- "$pattern"; then
                  file_dir=$(dirname "$pattern")
                  backup_dir="$BACKUP_ROOT/$file_dir"
                  mkdir -p "$backup_dir"
                  backup_name="$(basename "$pattern").$(date +%Y%m%d_%H%M%S).backup"
                  cp "$pattern" "$backup_dir/$backup_name"
                  echo "$file_dir/$backup_name" >> "$BACKUP_FILES_LIST"
                  echo "âœ… å¤‡ä»½å·²ä¿®æ”¹çš„æ–‡ä»¶: $pattern"
                fi
                # ä¿å­˜åˆ°ä¸´æ—¶ç›®å½•ç”¨äºåç»­æ¢å¤
                target_dir="$TEMP_DIR/$(dirname "$pattern")"
                mkdir -p "$target_dir"
                cp "$pattern" "$TEMP_DIR/$pattern"
              fi
            fi
          done <<< "$EXCLUDE_PATTERNS"
          
          echo "ğŸ”„ åˆ‡æ¢åˆ°mainåˆ†æ”¯ä»£ç ..."
          git checkout main -- .
          
          echo "ğŸ“¥ æ¢å¤ä¿ç•™çš„æ–‡ä»¶..."
          if [ -d "$TEMP_DIR" ]; then
            cp -r "$TEMP_DIR"/* .
            echo "âœ… æ¢å¤å®Œæˆ"
          fi
          
          # è¯»å–å¤‡ä»½æ–‡ä»¶åˆ—è¡¨
          BACKUP_FILES=""
          if [ -f "$BACKUP_FILES_LIST" ]; then
            BACKUP_FILES=$(cat "$BACKUP_FILES_LIST")
          fi
          
          # æäº¤æ›´æ”¹
          git add -A
          if git diff --cached --quiet; then
            echo "âœ¨ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "åŒæ­¥mainåˆ†æ”¯ä»£ç å¹¶ä¿ç•™è‡ªå®šä¹‰ä¿®æ”¹"
            echo "âœ… æ›´æ”¹å·²æäº¤"
          fi
          
          # æ¨é€æ›´æ”¹
          git push --force origin custom-dev
          echo "ğŸš€ æ›´æ”¹å·²æ¨é€åˆ°custom-devåˆ†æ”¯"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ç”¨äºåˆ›å»ºIssue
          if [ ! -z "$BACKUP_FILES" ]; then
            echo "BACKUP_FILES<<EOF" >> $GITHUB_ENV
            echo "$BACKUP_FILES" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            # è®¾ç½®æ ‡å¿—ï¼Œè¡¨ç¤ºéœ€è¦åˆ›å»ºIssue
            echo "NEED_CREATE_ISSUE=true" >> $GITHUB_ENV
            
            echo "ğŸ“‹ æ£€æµ‹åˆ°æ–‡ä»¶ä¿®æ”¹ï¼Œå°†åˆ›å»ºIssueæŠ¥å‘Šæƒ…å†µ..."
          else
            echo "âœ… æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶ä¿®æ”¹"
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf "$TEMP_DIR" "$BACKUP_ROOT"
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶å®Œæˆ"

      - name: åˆ›å»ºIssueæŠ¥å‘Š
        if: env.NEED_CREATE_ISSUE == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            console.log('ğŸ“ æ­£åœ¨åˆ›å»ºåŒæ­¥æŠ¥å‘Š...');
            
            const issueBody = `
            # main -> custom-dev åŒæ­¥æŠ¥å‘Š
            
            åœ¨åŒæ­¥è¿‡ç¨‹ä¸­ï¼Œä»¥ä¸‹æ–‡ä»¶åœ¨ custom-dev åˆ†æ”¯ä¸­æœ‰è‡ªå®šä¹‰ä¿®æ”¹ï¼Œå·²è‡ªåŠ¨å¤‡ä»½ï¼š
            
            ## å·²å¤‡ä»½çš„æ–‡ä»¶
            \`\`\`
            ${process.env.BACKUP_FILES}
            \`\`\`
            
            ## å¤„ç†è¯´æ˜
            1. ä»¥ä¸Šæ–‡ä»¶å·²åœ¨åŒç›®å½•ä¸‹åˆ›å»ºå¤‡ä»½
            2. æ–‡ä»¶å·²æŒ‰ç…§ sync-exclude.txt çš„é…ç½®è¿›è¡Œäº†ä¿ç•™
            3. å¦‚éœ€è¿›ä¸€æ­¥è°ƒæ•´ï¼Œè¯·å‚è€ƒå¤‡ä»½æ–‡ä»¶è¿›è¡Œæ‰‹åŠ¨åˆå¹¶
            
            ## åç»­æ­¥éª¤
            1. æ£€æŸ¥å¤‡ä»½æ–‡ä»¶çš„å†…å®¹
            2. ç¡®è®¤å½“å‰æ–‡ä»¶çš„å†…å®¹æ˜¯å¦ç¬¦åˆé¢„æœŸ
            3. å¦‚éœ€è°ƒæ•´ï¼Œè¯·åœ¨ custom-dev åˆ†æ”¯ä¸Šè¿›è¡Œä¿®æ”¹
            4. å®Œæˆåå¯ä»¥åˆ é™¤å¤‡ä»½æ–‡ä»¶
            `;
            
            console.log('ğŸ“¤ æäº¤Issue...');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ”„ main -> custom-dev åŒæ­¥æŠ¥å‘Š',
              body: issueBody,
              labels: ['sync-report']
            });
            console.log('âœ… Issueåˆ›å»ºæˆåŠŸ');
      
      - name: Notify result
        run: |
          echo "âœ… åŒæ­¥æµç¨‹å·²å®Œæˆã€‚å¦‚æœ‰å¤‡ä»½æ–‡ä»¶ï¼Œè¯·æŸ¥çœ‹åˆ›å»ºçš„Issueäº†è§£è¯¦æƒ…ã€‚"
