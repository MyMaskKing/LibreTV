name: åŒæ­¥mainåˆ°devæµ‹è¯•åˆ†æ”¯(Betaç‰ˆ)

on:
  # åªå…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  BACKUP_DIR: '.sync-backups'
  TEMP_DIR: '.sync-temp'
  BACKUP_RETAIN_DAYS: 7
  # æ’é™¤æ–‡ä»¶é…ç½®æ–‡ä»¶è·¯å¾„
  EXCLUDE_FILES_CONFIG: 'sync-exclude.txt'

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: é…ç½®Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          echo "âœ… Gité…ç½®å®Œæˆ"
      
      - name: è¯»å–æ’é™¤æ–‡ä»¶åˆ—è¡¨å¹¶å¤‡ä»½
        id: backup
        run: |
          if [ ! -f "$EXCLUDE_FILES_CONFIG" ]; then
            echo "âŒ é”™è¯¯ï¼šæ’é™¤æ–‡ä»¶é…ç½® $EXCLUDE_FILES_CONFIG ä¸å­˜åœ¨"
            exit 1
          fi
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p "$TEMP_DIR"
          
          # å¤‡ä»½é…ç½®æ–‡ä»¶
          cp "$EXCLUDE_FILES_CONFIG" "$TEMP_DIR/exclude_config.bak"
          
          # è¯»å–å¹¶å¤„ç†æ’é™¤æ–‡ä»¶åˆ—è¡¨
          EXCLUDE_PATTERNS=()
          while IFS= read -r line || [[ -n "$line" ]]; do
            if [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]]; then
              continue
            fi
            line=$(echo "$line" | xargs)
            if [[ -n "$line" ]]; then
              EXCLUDE_PATTERNS+=("$line")
              echo "ğŸ“‹ è¯»å–åˆ°éœ€è¦ä¿ç•™çš„æ–‡ä»¶/ç›®å½•: $line"
            fi
          done < "$EXCLUDE_FILES_CONFIG"
          
          # å¤‡ä»½éœ€è¦ä¿ç•™çš„æ–‡ä»¶
          for pattern in "${EXCLUDE_PATTERNS[@]}"; do
            if [[ "$pattern" == */ ]]; then
              # ç›®å½•æ¨¡å¼
              if [ -d "$pattern" ]; then
                mkdir -p "$TEMP_DIR/$pattern"
                cp -r "$pattern"* "$TEMP_DIR/$pattern" 2>/dev/null || true
                echo "ğŸ“¦ å¤‡ä»½ç›®å½•: $pattern"
              fi
            else
              # æ–‡ä»¶æ¨¡å¼
              if [ -f "$pattern" ]; then
                target_dir="$TEMP_DIR/$(dirname "$pattern")"
                mkdir -p "$target_dir"
                cp -r "$pattern" "$target_dir/" 2>/dev/null || true
                echo "ğŸ“„ å¤‡ä»½æ–‡ä»¶: $pattern"
              fi
            fi
          done
          
          # å°†æ’é™¤æ¨¡å¼åˆ—è¡¨ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          {
            echo "EXCLUDE_PATTERNS<<EOF"
            printf "%s\n" "${EXCLUDE_PATTERNS[@]}"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: å‡†å¤‡åˆ†æ”¯
        id: prepare
        run: |
          echo "ğŸ”„ è·å–æœ€æ–°ä»£ç ..."
          git fetch origin
          git fetch origin main:main
          
          echo "ğŸ” æ£€æŸ¥custom-devåˆ†æ”¯..."
          if ! git show-ref --verify --quiet refs/remotes/origin/custom-dev; then
            echo "âš ï¸ custom-devåˆ†æ”¯ä¸å­˜åœ¨ï¼Œä»mainåˆ›å»º..."
            git checkout -b custom-dev origin/main
          else
            echo "âœ… åˆ‡æ¢åˆ°custom-devåˆ†æ”¯"
            git checkout custom-dev
            git reset --hard origin/custom-dev
          fi

      - name: æ™ºèƒ½åˆå¹¶
        id: merge
        run: |
          echo "ğŸ”„ å¼€å§‹æ™ºèƒ½åˆå¹¶..."
          
          # 1. å…ˆå°†æ‰€æœ‰æ–‡ä»¶é‡ç½®ä¸ºmainåˆ†æ”¯ç‰ˆæœ¬
          echo "ğŸ“¥ åº”ç”¨mainåˆ†æ”¯çš„æ‰€æœ‰æ›´æ”¹..."
          git checkout origin/main -- .
          
          # 2. æ¢å¤excludeåˆ—è¡¨ä¸­çš„æ–‡ä»¶
          while IFS= read -r pattern; do
            if [ -z "$pattern" ]; then
              continue
            fi
            
            echo "ğŸ”„ å¤„ç†: $pattern"
            
            # è·³è¿‡æ³¨é‡Šè¡Œ
            if [[ "$pattern" =~ ^[[:space:]]*# ]]; then
              continue
            fi
            
            # å¤„ç†ç›®å½•
            if [[ "$pattern" == */ ]]; then
              if [ -d "$TEMP_DIR/$pattern" ]; then
                echo "  ğŸ“‚ æ¢å¤ç›®å½•: $pattern"
                rm -rf "$pattern"
                cp -r "$TEMP_DIR/$pattern" "$(dirname "$pattern")/"
              fi
              continue
            fi
            
            # å¤„ç†å•ä¸ªæ–‡ä»¶
            if [ -f "$TEMP_DIR/$pattern" ]; then
              echo "  ğŸ“„ å¤„ç†æ–‡ä»¶: $pattern"
              
              # æ£€æŸ¥æ–‡ä»¶åœ¨mainåˆ†æ”¯æ˜¯å¦æœ‰æ›´æ”¹
              if git diff --quiet origin/main origin/custom-dev -- "$pattern" 2>/dev/null; then
                echo "    âœ“ æ–‡ä»¶æ— å·®å¼‚ï¼Œä½¿ç”¨åŸæ–‡ä»¶"
                cp -f "$TEMP_DIR/$pattern" "$pattern"
              else
                echo "    âš ï¸ æ£€æµ‹åˆ°å·®å¼‚ï¼Œå°è¯•åˆå¹¶..."
                
                # åˆ›å»ºä¸´æ—¶æ–‡ä»¶ç”¨äºåˆå¹¶
                TEMP_MERGE_DIR="$TEMP_DIR/merge"
                mkdir -p "$TEMP_MERGE_DIR"
                BASE_FILE="$TEMP_MERGE_DIR/base"
                OURS_FILE="$TEMP_MERGE_DIR/ours"
                THEIRS_FILE="$TEMP_MERGE_DIR/theirs"
                
                # è·å–æ–‡ä»¶çš„å„ä¸ªç‰ˆæœ¬
                git show "origin/main:$pattern" > "$BASE_FILE" 2>/dev/null || touch "$BASE_FILE"
                cp "$TEMP_DIR/$pattern" "$OURS_FILE"
                git show "origin/main:$pattern" > "$THEIRS_FILE" 2>/dev/null || touch "$THEIRS_FILE"
                
                # å°è¯•ä¸‰æ–¹åˆå¹¶
                if git merge-file -p "$OURS_FILE" "$BASE_FILE" "$THEIRS_FILE" > "$pattern" 2>/dev/null; then
                  echo "    âœ… è‡ªåŠ¨åˆå¹¶æˆåŠŸ"
                else
                  echo "    âŒ åˆå¹¶å†²çª"
                  echo "$pattern" >> "$TEMP_DIR/conflict_files.txt"
                  # æš‚æ—¶ä½¿ç”¨mainç‰ˆæœ¬
                  git checkout origin/main -- "$pattern"
                fi
                
                # æ¸…ç†ä¸´æ—¶åˆå¹¶æ–‡ä»¶
                rm -rf "$TEMP_MERGE_DIR"
              fi
            fi
          done <<< "$EXCLUDE_PATTERNS"
          
          # 3. æ£€æŸ¥æ˜¯å¦æœ‰å†²çªæ–‡ä»¶
          if [ -f "$TEMP_DIR/conflict_files.txt" ]; then
            echo "MERGE_CONFLICT=true" >> $GITHUB_ENV
            echo "CONFLICT_FILES<<EOF" >> $GITHUB_ENV
            cat "$TEMP_DIR/conflict_files.txt" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "MERGE_CONFLICT=false" >> $GITHUB_ENV
          fi
          
          # 4. æäº¤æ›´æ”¹
          git add -A
          if git diff --cached --quiet; then
            echo "âœ… æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "åŒæ­¥mainåˆ†æ”¯ä»£ç ï¼Œä¿ç•™custom-devåˆ†æ”¯çš„è‡ªå®šä¹‰ä¿®æ”¹"
            git push -f origin custom-dev
          fi

      - name: åˆ›å»ºIssueæŠ¥å‘Š
        if: env.MERGE_CONFLICT == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const issueBody = `
            # main -> custom-dev åŒæ­¥å†²çªæŠ¥å‘Š
            
            åœ¨åŒæ­¥è¿‡ç¨‹ä¸­å‘ç°ä»¥ä¸‹æ–‡ä»¶å­˜åœ¨å†²çªï¼Œå·²æš‚æ—¶ä½¿ç”¨mainåˆ†æ”¯çš„ç‰ˆæœ¬ã€‚
            è¿™äº›æ–‡ä»¶éƒ½åœ¨ \`sync-exclude.txt\` ä¸­åˆ—å‡ºï¼Œéœ€è¦ä¿ç•™custom-devçš„è‡ªå®šä¹‰ä¿®æ”¹ã€‚
            
            ## å†²çªæ–‡ä»¶åˆ—è¡¨
            \`\`\`
            ${process.env.CONFLICT_FILES}
            \`\`\`
            
            ## å¤‡ä»½ä½ç½®
            æ‰€æœ‰æ–‡ä»¶çš„custom-devç‰ˆæœ¬å·²å¤‡ä»½åœ¨ \`${process.env.TEMP_DIR}\` ç›®å½•ä¸‹ï¼Œä¿æŒåŸæœ‰ç›®å½•ç»“æ„ã€‚
            
            ## å¤„ç†è¯´æ˜
            1. ç›®å‰è¿™äº›æ–‡ä»¶ä½¿ç”¨äº†mainåˆ†æ”¯çš„ç‰ˆæœ¬
            2. custom-devåˆ†æ”¯çš„åŸå§‹ä»£ç å·²å¤‡ä»½
            3. è¯·æ‰‹åŠ¨åˆå¹¶è¿™äº›æ–‡ä»¶çš„æ›´æ”¹
            
            ## æ‰‹åŠ¨å¤„ç†æ­¥éª¤
            1. æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å†…å®¹
            2. åœ¨custom-devåˆ†æ”¯ä¸Šæ‰‹åŠ¨åˆå¹¶æ›´æ”¹
            3. ç¡®ä¿åˆå¹¶åçš„ä»£ç ä¸mainåˆ†æ”¯çš„æ”¹åŠ¨ä¸å†²çª
            4. æäº¤å¹¶æ¨é€æ›´æ”¹åˆ°custom-devåˆ†æ”¯
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ”„ main -> custom-dev åŒæ­¥å†²çªæŠ¥å‘Š',
              body: issueBody,
              labels: ['sync-conflict']
            });

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          rm -rf $TEMP_DIR
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶å®Œæˆ"
      
      - name: é€šçŸ¥ç»“æœ
        run: |
          if [ "$MERGE_CONFLICT" = "true" ]; then
            echo "âš ï¸ åŒæ­¥å®Œæˆï¼Œä½†æœ‰å†²çªæ–‡ä»¶éœ€è¦å¤„ç†ï¼Œè¯·æŸ¥çœ‹åˆ›å»ºçš„Issueã€‚"
          else
            echo "âœ… åŒæ­¥å®Œæˆï¼mainåˆ†æ”¯ä»£ç å·²åŒæ­¥åˆ°custom-devï¼Œå¹¶ä¿ç•™äº†è‡ªå®šä¹‰ä¿®æ”¹ã€‚"
          fi
