name: åŒæ­¥mainåˆ°devæµ‹è¯•åˆ†æ”¯(Betaç‰ˆ)

on:
  # åªå…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  BACKUP_DIR: '.sync-backups'
  TEMP_DIR: '.sync-temp'
  BACKUP_RETAIN_DAYS: 7
  # æ’é™¤æ–‡ä»¶é…ç½®æ–‡ä»¶è·¯å¾„
  EXCLUDE_FILES_CONFIG: 'sync-exclude.txt'

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: é…ç½®Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          echo "âœ… Gité…ç½®å®Œæˆ"
      
      - name: æ™ºèƒ½åŒæ­¥mainåˆ†æ”¯åˆ°custom-dev
        run: |
          echo "ğŸš€ å¼€å§‹æ™ºèƒ½åŒæ­¥mainåˆ†æ”¯åˆ°custom-devåˆ†æ”¯..."
          
          echo "ğŸ“¥ è·å–æœ€æ–°ä»£ç ..."
          git fetch origin
          git fetch origin main:main
          
          echo "ğŸ” æ£€æŸ¥custom-devåˆ†æ”¯çŠ¶æ€..."
          if ! git show-ref --verify --quiet refs/remotes/origin/custom-dev; then
            echo "âš ï¸ custom-devåˆ†æ”¯ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
            git checkout -b custom-dev
            echo "âœ… custom-devåˆ†æ”¯åˆ›å»ºæˆåŠŸ"
          else
            echo "âœ… åˆ‡æ¢åˆ°å·²å­˜åœ¨çš„custom-devåˆ†æ”¯"
            git checkout custom-dev
            echo "ğŸ”„ é‡ç½®åˆ†æ”¯åˆ°æœ€æ–°çŠ¶æ€"
            git reset --hard origin/custom-dev
          fi

          # æ£€æŸ¥æ’é™¤æ–‡ä»¶é…ç½®æ˜¯å¦å­˜åœ¨
          if [ ! -f "$EXCLUDE_FILES_CONFIG" ]; then
            echo "âŒ é”™è¯¯ï¼šæ’é™¤æ–‡ä»¶é…ç½® $EXCLUDE_FILES_CONFIG ä¸å­˜åœ¨"
            echo "è¯·å…ˆåœ¨ custom-dev åˆ†æ”¯åˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œå®šä¹‰éœ€è¦ä¿ç•™çš„è‡ªå®šä¹‰ä¿®æ”¹"
            echo "é…ç½®æ–‡ä»¶æ ¼å¼ç¤ºä¾‹ï¼š"
            echo "# è¿™ä¸ªæ–‡ä»¶å®šä¹‰äº†å“ªäº›æ–‡ä»¶åº”è¯¥ä¿ç•™custom-devåˆ†æ”¯çš„ä¿®æ”¹"
            echo "# æ¯è¡Œä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•è·¯å¾„ï¼Œæ”¯æŒé€šé…ç¬¦"
            echo "# ä»¥#å¼€å¤´çš„è¡Œä¸ºæ³¨é‡Š"
            echo ""
            echo ".github/workflows/"
            echo "js/sync/sync.js"
            echo "player.html"
            echo "$EXCLUDE_FILES_CONFIG"
            exit 1
          fi

          # ä¿å­˜é…ç½®æ–‡ä»¶
          echo "ğŸ’¾ ä¿å­˜é…ç½®æ–‡ä»¶..."
          mkdir -p "$TEMP_DIR"
          cp "$EXCLUDE_FILES_CONFIG" "$TEMP_DIR/exclude_config.bak"

          # è¯»å–æ’é™¤æ–‡ä»¶åˆ—è¡¨
          echo "ğŸ“‹ è¯»å–æ’é™¤æ–‡ä»¶åˆ—è¡¨..."
          EXCLUDE_PATTERNS=()
          while IFS= read -r line || [[ -n "$line" ]]; do
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
            if [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]]; then
              continue
            fi
            # å»é™¤å‰åç©ºæ ¼
            line=$(echo "$line" | xargs)
            if [[ -n "$line" ]]; then
              EXCLUDE_PATTERNS+=("$line")
              echo "  - æ’é™¤: $line"
            fi
          done < "$EXCLUDE_FILES_CONFIG"

          # å¤‡ä»½éœ€è¦ä¿ç•™çš„æ–‡ä»¶
          echo "ğŸ’¾ å¤‡ä»½éœ€è¦ä¿ç•™çš„æ–‡ä»¶..."
          for pattern in "${EXCLUDE_PATTERNS[@]}"; do
            # å¤„ç†ç›®å½•æ¨¡å¼ï¼ˆä»¥/ç»“å°¾ï¼‰
            if [[ "$pattern" == */ ]]; then
              echo "ğŸ“„ å¤‡ä»½ç›®å½•: $pattern"
              mkdir -p "$TEMP_DIR/$pattern"
              cp -r "$pattern"* "$TEMP_DIR/$pattern" 2>/dev/null || true
            else
              # å¤„ç†å…·ä½“æ–‡ä»¶æˆ–é€šé…ç¬¦
              echo "ğŸ“„ å¤‡ä»½æ–‡ä»¶: $pattern"
              # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
              target_dir="$TEMP_DIR/$(dirname "$pattern")"
              mkdir -p "$target_dir"
              cp -r $pattern "$target_dir/" 2>/dev/null || true
            fi
          done

          # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜å‚¨å·®å¼‚
          echo "ğŸ“‚ åˆ›å»ºä¸´æ—¶ç›®å½•å­˜å‚¨å·®å¼‚..."
          REPO_ROOT=$(pwd)
          DIFF_DIR="${REPO_ROOT}/$TEMP_DIR/diff-patches"
          rm -rf "$DIFF_DIR"
          mkdir -p "$DIFF_DIR"

          # è·å–mainåˆ†æ”¯çš„æœ€æ–°ä»£ç 
          echo "ğŸ”„ è·å–mainåˆ†æ”¯çš„æœ€æ–°ä»£ç ..."
          git fetch origin main
          
          # é‡ç½®å½“å‰åˆ†æ”¯åˆ°mainåˆ†æ”¯çš„çŠ¶æ€ï¼Œä½†ä¸æäº¤
          echo "ğŸ”„ é‡ç½®å½“å‰åˆ†æ”¯åˆ°mainåˆ†æ”¯çš„çŠ¶æ€..."
          git reset --mixed origin/main

          # æ¢å¤é…ç½®æ–‡ä»¶
          echo "ğŸ”„ æ¢å¤é…ç½®æ–‡ä»¶..."
          mkdir -p $(dirname "$EXCLUDE_FILES_CONFIG")
          cp "$TEMP_DIR/exclude_config.bak" "$EXCLUDE_FILES_CONFIG"
          git add "$EXCLUDE_FILES_CONFIG"

          # ä¸ºå¤‡ä»½çš„æ–‡ä»¶åˆ›å»ºè¡¥ä¸
          echo "ğŸ” ä¸ºå¤‡ä»½çš„æ–‡ä»¶åˆ›å»ºè¡¥ä¸..."
          for pattern in "${EXCLUDE_PATTERNS[@]}"; do
            if [[ "$pattern" == */ ]]; then
              # å¤„ç†ç›®å½•
              backup_dir="$TEMP_DIR/$pattern"
              if [ -d "$backup_dir" ]; then
                echo "ğŸ“„ å¤„ç†å¤‡ä»½ç›®å½•: $pattern"
                find "$backup_dir" -type f | while read backup_file; do
                  # è·å–ç›¸å¯¹è·¯å¾„
                  rel_path=${backup_file#"$TEMP_DIR/"}
                  # åˆ›å»ºç›®æ ‡ç›®å½•
                  target_dir=$(dirname "$rel_path")
                  mkdir -p "$target_dir"
                  
                  # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨äºmainåˆ†æ”¯
                  if [ -f "$rel_path" ]; then
                    # åˆ›å»ºè¡¥ä¸
                    diff_file="${DIFF_DIR}/${rel_path//\//_}.patch"
                    echo "  - ä¸ºæ–‡ä»¶åˆ›å»ºè¡¥ä¸: $rel_path"
                    diff -u "$rel_path" "$backup_file" > "$diff_file" 2>/dev/null || true
                    
                    # æ£€æŸ¥è¡¥ä¸æ˜¯å¦ä¸ºç©º
                    if [ ! -s "$diff_file" ]; then
                      echo "    - æ–‡ä»¶æ²¡æœ‰å·®å¼‚ï¼Œè·³è¿‡"
                      rm "$diff_file"  # åˆ é™¤ç©ºè¡¥ä¸
                    else
                      echo "    - è¡¥ä¸åˆ›å»ºæˆåŠŸ: $(wc -l < "$diff_file") è¡Œ"
                      # ç›´æ¥å¤åˆ¶æ–‡ä»¶ä»¥ç¡®ä¿ä¿®æ”¹è¢«åº”ç”¨
                      cp "$backup_file" "$rel_path"
                      git add "$rel_path"
                    fi
                  else
                    # æ–‡ä»¶åœ¨mainåˆ†æ”¯ä¸å­˜åœ¨ï¼Œç›´æ¥å¤åˆ¶
                    echo "  - å¤åˆ¶æ–°æ–‡ä»¶: $rel_path"
                    cp "$backup_file" "$rel_path"
                    git add "$rel_path"
                  fi
                done
              fi
            else
              # å¤„ç†å•ä¸ªæ–‡ä»¶
              backup_pattern="$TEMP_DIR/$pattern"
              # ä½¿ç”¨é€šé…ç¬¦å±•å¼€
              shopt -s nullglob
              backup_files=($backup_pattern)
              shopt -u nullglob
              
              for backup_file in "${backup_files[@]}"; do
                if [ -f "$backup_file" ]; then
                  # è·å–ç›¸å¯¹è·¯å¾„
                  rel_path=${backup_file#"$TEMP_DIR/"}
                  echo "ğŸ“„ å¤„ç†å¤‡ä»½æ–‡ä»¶: $rel_path"
                  
                  # åˆ›å»ºç›®æ ‡ç›®å½•
                  target_dir=$(dirname "$rel_path")
                  mkdir -p "$target_dir"
                  
                  # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨äºmainåˆ†æ”¯
                  if [ -f "$rel_path" ]; then
                    # åˆ›å»ºè¡¥ä¸
                    diff_file="${DIFF_DIR}/${rel_path//\//_}.patch"
                    echo "  - ä¸ºæ–‡ä»¶åˆ›å»ºè¡¥ä¸: $rel_path"
                    diff -u "$rel_path" "$backup_file" > "$diff_file" 2>/dev/null || true
                    
                    # æ£€æŸ¥è¡¥ä¸æ˜¯å¦ä¸ºç©º
                    if [ ! -s "$diff_file" ]; then
                      echo "    - æ–‡ä»¶æ²¡æœ‰å·®å¼‚ï¼Œè·³è¿‡"
                      rm "$diff_file"  # åˆ é™¤ç©ºè¡¥ä¸
                    else
                      echo "    - è¡¥ä¸åˆ›å»ºæˆåŠŸ: $(wc -l < "$diff_file") è¡Œ"
                      # ç›´æ¥å¤åˆ¶æ–‡ä»¶ä»¥ç¡®ä¿ä¿®æ”¹è¢«åº”ç”¨
                      cp "$backup_file" "$rel_path"
                      git add "$rel_path"
                    fi
                  else
                    # æ–‡ä»¶åœ¨mainåˆ†æ”¯ä¸å­˜åœ¨ï¼Œç›´æ¥å¤åˆ¶
                    echo "  - å¤åˆ¶æ–°æ–‡ä»¶: $rel_path"
                    cp "$backup_file" "$rel_path"
                    git add "$rel_path"
                  fi
                fi
              done
            fi
          done

          # åˆ—å‡ºåˆ›å»ºçš„è¡¥ä¸æ–‡ä»¶
          echo "ğŸ“‹ åˆ›å»ºçš„è¡¥ä¸æ–‡ä»¶åˆ—è¡¨:"
          if [ -d "$DIFF_DIR" ]; then
            find "$DIFF_DIR" -type f -name "*.patch" | sort
            echo "è¡¥ä¸æ–‡ä»¶æ€»æ•°: $(find "$DIFF_DIR" -type f -name "*.patch" | wc -l)"
          else
            echo "è¡¥ä¸ç›®å½•ä¸å­˜åœ¨"
          fi

          # åº”ç”¨è¡¥ä¸ï¼ˆä½œä¸ºå‚è€ƒï¼Œä½†å®é™…å·²ç»ç›´æ¥å¤åˆ¶äº†æ–‡ä»¶ï¼‰
          echo "ğŸ”„ åº”ç”¨è¡¥ä¸..."
          PATCH_COUNT=0
          REJECT_COUNT=0
          
          # æ£€æŸ¥è¡¥ä¸ç›®å½•æ˜¯å¦å­˜åœ¨è¡¥ä¸æ–‡ä»¶
          if [ -d "$DIFF_DIR" ] && [ "$(ls -A "$DIFF_DIR" 2>/dev/null)" ]; then
            echo "ğŸ” æ‰¾åˆ°è¡¥ä¸æ–‡ä»¶ï¼Œå¼€å§‹åº”ç”¨..."
            
            for patch_file in "$DIFF_DIR"/*.patch; do
              if [ -s "$patch_file" ]; then  # åªå¤„ç†éç©ºè¡¥ä¸æ–‡ä»¶
                # ä»è¡¥ä¸æ–‡ä»¶åæ¢å¤åŸå§‹æ–‡ä»¶è·¯å¾„
                original_file=$(basename "$patch_file" .patch | tr '_' '/')
                
                echo "ğŸ“„ åº”ç”¨è¡¥ä¸åˆ°æ–‡ä»¶: $original_file"
                PATCH_COUNT=$((PATCH_COUNT + 1))
                
                # åˆ›å»ºç›®å½•ï¼ˆå¦‚æœéœ€è¦ï¼‰
                mkdir -p "$(dirname "$original_file")" 2>/dev/null || true
                
                # åº”ç”¨è¡¥ä¸ï¼ˆæ³¨æ„ï¼šæ–‡ä»¶å·²ç»åœ¨å‰é¢ç›´æ¥å¤åˆ¶äº†ï¼Œè¿™é‡Œåªæ˜¯è®°å½•ï¼‰
                if ! patch -p0 "$original_file" "$patch_file" 2>/dev/null; then
                  echo "âš ï¸ è¡¥ä¸åº”ç”¨å¤±è´¥ï¼Œä½†æ–‡ä»¶å·²ç»ç›´æ¥ä»å¤‡ä»½å¤åˆ¶ï¼Œæ— éœ€æ‹…å¿ƒ"
                  REJECT_COUNT=$((REJECT_COUNT + 1))
                fi
              fi
            done
          else
            echo "â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°éœ€è¦åº”ç”¨çš„è¡¥ä¸æ–‡ä»¶"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ‹’ç»çš„è¡¥ä¸
          REJECT_FILES=$(find . -name "*.rej")
          if [ -n "$REJECT_FILES" ]; then
            echo "âš ï¸ è­¦å‘Šï¼šä»¥ä¸‹æ–‡ä»¶çš„è¡¥ä¸åº”ç”¨å¤±è´¥ï¼Œä½†æ–‡ä»¶å·²ç»ç›´æ¥ä»å¤‡ä»½å¤åˆ¶ï¼š"
            echo "$REJECT_FILES"
            # åˆ é™¤æ‹’ç»æ–‡ä»¶ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»ç›´æ¥å¤åˆ¶äº†æ–‡ä»¶
            find . -name "*.rej" -delete
          fi
          
          echo "ğŸ“Š è¡¥ä¸ç»Ÿè®¡: åº”ç”¨ $PATCH_COUNT ä¸ªè¡¥ä¸ï¼Œ$REJECT_COUNT ä¸ªå¤±è´¥ï¼ˆä½†æ–‡ä»¶å·²ç»ç›´æ¥å¤åˆ¶ï¼‰"

          # æ¸…ç†å·®å¼‚ç›®å½•
          rm -rf "$DIFF_DIR"
          
          # æäº¤æ›´æ”¹
          echo "ğŸ“ æäº¤æ›´æ”¹..."
          git add -A
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if git diff --cached --quiet; then
            echo "âœ… æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹ï¼ŒåŒæ­¥å®Œæˆ"
          else
            git commit -m "åŒæ­¥mainåˆ†æ”¯ä»£ç ï¼Œä¿ç•™custom-devåˆ†æ”¯çš„è‡ªå®šä¹‰ä¿®æ”¹"
            
            echo "ğŸš€ æ¨é€åˆ°custom-devåˆ†æ”¯..."
            git push --force origin custom-dev
            
            echo "âœ… åŒæ­¥å®Œæˆ"
          fi

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          rm -rf $TEMP_DIR
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶å®Œæˆ"
      
      - name: é€šçŸ¥ç»“æœ
        run: |
          echo "âœ… æ™ºèƒ½åŒæ­¥æµç¨‹å·²å®Œæˆã€‚custom-dev åˆ†æ”¯ç°åœ¨åŒ…å« main åˆ†æ”¯çš„ä»£ç ï¼Œå¹¶ä¿ç•™äº†æ’é™¤åˆ—è¡¨ä¸­æŒ‡å®šçš„è‡ªå®šä¹‰ä¿®æ”¹ã€‚" 
