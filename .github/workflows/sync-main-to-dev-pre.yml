name: åŒæ­¥mainåˆ°devæµ‹è¯•åˆ†æ”¯(Betaç‰ˆ)

on:
  # åªå…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  BACKUP_DIR: '.sync-backups'
  TEMP_DIR: '.sync-temp'
  BACKUP_RETAIN_DAYS: 7
  # æ’é™¤æ–‡ä»¶é…ç½®æ–‡ä»¶è·¯å¾„
  EXCLUDE_FILES_CONFIG: 'sync-exclude.txt'

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: é…ç½®Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          echo "âœ… Gité…ç½®å®Œæˆ"
      
      - name: è¯»å–æ’é™¤æ–‡ä»¶åˆ—è¡¨å¹¶å¤‡ä»½
        id: backup
        run: |
          if [ ! -f "$EXCLUDE_FILES_CONFIG" ]; then
            echo "âŒ é”™è¯¯ï¼šæ’é™¤æ–‡ä»¶é…ç½® $EXCLUDE_FILES_CONFIG ä¸å­˜åœ¨"
            exit 1
          fi
          mkdir -p "$TEMP_DIR"
          cp "$EXCLUDE_FILES_CONFIG" "$TEMP_DIR/exclude_config.bak"
          EXCLUDE_PATTERNS=()
          while IFS= read -r line || [[ -n "$line" ]]; do
            if [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]]; then
              continue
            fi
            line=$(echo "$line" | xargs)
            if [[ -n "$line" ]]; then
              EXCLUDE_PATTERNS+=("$line")
              echo "  - æ’é™¤: $line"
            fi
          done < "$EXCLUDE_FILES_CONFIG"
          for pattern in "${EXCLUDE_PATTERNS[@]}"; do
            if [[ "$pattern" == */ ]]; then
              mkdir -p "$TEMP_DIR/$pattern"
              cp -r "$pattern"* "$TEMP_DIR/$pattern" 2>/dev/null || true
            else
              target_dir="$TEMP_DIR/$(dirname "$pattern")"
              mkdir -p "$target_dir"
              cp -r $pattern "$target_dir/" 2>/dev/null || true
            fi
          done

      - name: åˆå¹¶mainåˆ†æ”¯åˆ°custom-dev
        id: merge
        run: |
          git fetch origin
          git fetch origin main:main
          if ! git show-ref --verify --quiet refs/remotes/origin/custom-dev; then
            git checkout -b custom-dev
          else
            git checkout custom-dev
            git reset --hard origin/custom-dev
          fi
          git merge --abort || true
          if git merge origin/main --no-commit; then
            echo "MERGE_CONFLICT=false" >> $GITHUB_ENV
          else
            echo "MERGE_CONFLICT=true" >> $GITHUB_ENV
          fi

      - name: æ£€æŸ¥å¹¶å¤„ç†åˆå¹¶å†²çª
        if: env.MERGE_CONFLICT == 'true'
        id: handle_conflict
        run: |
          CONFLICT_FILES=$(git status --porcelain | grep "^UU" | cut -c4-)
          if [ -z "$CONFLICT_FILES" ]; then
            echo "âŒ æ²¡æœ‰æ£€æµ‹åˆ°å†²çªæ–‡ä»¶ï¼Œå¯èƒ½æ˜¯å…¶ä»–é”™è¯¯"
            git status
            exit 1
          fi
          FILTERED_CONFLICT_FILES=""
          while IFS= read -r file; do
            if [[ ! "$file" =~ ^\.github/workflows/ ]]; then
              FILTERED_CONFLICT_FILES="${FILTERED_CONFLICT_FILES}${file}\n"
            fi
          done <<< "$CONFLICT_FILES"
          FILTERED_CONFLICT_FILES=$(echo -e "$FILTERED_CONFLICT_FILES" | sed '$ s/\\n$//')
          echo "CONFLICT_FILES<<EOF" >> $GITHUB_ENV
          echo -e "$FILTERED_CONFLICT_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          BACKUP_FILES=""
          REPO_ROOT=$(pwd)
          BACKUP_ROOT="../backup_files"
          rm -rf "$BACKUP_ROOT"
          mkdir -p "$BACKUP_ROOT"
          while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi
            if [ ! -f "$file" ]; then
              continue
            fi
            file_dir=$(dirname "$file")
            backup_dir="$BACKUP_ROOT/$file_dir"
            mkdir -p "$backup_dir"
            backup_name="$(basename "$file").$(date +%Y%m%d_%H%M%S).backup"
            backup_file="$backup_dir/$backup_name"
            cp "$file" "$backup_file" || true
            if [ -f "$backup_file" ]; then
              BACKUP_FILES="${BACKUP_FILES}\n$backup_file"
              git checkout origin/main -- "$file"
              git add "$file"
            fi
          done <<< "$FILTERED_CONFLICT_FILES"
          git reset --hard HEAD
          git clean -f -d
          git checkout origin/main -- .
          rm -rf .github/workflows/*
          git checkout custom-dev -- .github/workflows/
          if [ -d "$BACKUP_ROOT" ]; then
            cp -r "$BACKUP_ROOT"/* .
            rm -rf "$BACKUP_ROOT"
          fi
          git add -A
          git commit -m "åŒæ­¥mainåˆ†æ”¯ä»£ç ï¼Œå¹¶ä¿å­˜å†²çªæ–‡ä»¶å¤‡ä»½" || echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          git push --force origin custom-dev
          echo "BACKUP_FILES<<EOF" >> $GITHUB_ENV
          echo -e "$BACKUP_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: åˆ›å»ºIssueæŠ¥å‘Š
        if: env.MERGE_CONFLICT == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const issueBody = `
            # main -> custom-dev åŒæ­¥å†²çªæŠ¥å‘Š
            
            åœ¨åŒæ­¥è¿‡ç¨‹ä¸­å‘ç°ä»¥ä¸‹æ–‡ä»¶å­˜åœ¨å†²çªï¼Œå·²è‡ªåŠ¨ä½¿ç”¨mainåˆ†æ”¯çš„ä»£ç å¹¶å¤‡ä»½åŸæ–‡ä»¶ã€‚
            
            ## å†²çªæ–‡ä»¶åˆ—è¡¨
            \n\n\`\`\`
            ${process.env.CONFLICT_FILES}
            \`\`\`
            
            ## å¤‡ä»½æ–‡ä»¶
            å·²åœ¨æ¯ä¸ªå†²çªæ–‡ä»¶çš„åŒç›®å½•ä¸‹åˆ›å»ºå¤‡ä»½æ–‡ä»¶ï¼š
            \n\n\`\`\`
            ${process.env.BACKUP_FILES}
            \`\`\`
            
            ## å¤„ç†è¯´æ˜
            1. æ‰€æœ‰å†²çªæ–‡ä»¶å·²ä½¿ç”¨mainåˆ†æ”¯çš„ç‰ˆæœ¬
            2. custom-devåˆ†æ”¯çš„åŸå§‹ä»£ç å·²åœ¨åŒç›®å½•ä¸‹å¤‡ä»½
            3. å¦‚éœ€æ¢å¤æˆ–åˆå¹¶è‡ªå®šä¹‰ä»£ç ï¼Œè¯·å‚è€ƒå¤‡ä»½æ–‡ä»¶
            
            ## æ‰‹åŠ¨å¤„ç†æ­¥éª¤
            1. æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å†…å®¹
            2. å¦‚éœ€ä¿®æ”¹ï¼Œè¯·åœ¨custom-devåˆ†æ”¯ä¸Šè¿›è¡Œæ›´æ”¹
            3. ç¡®ä¿æ›´æ”¹åçš„ä»£ç ä¸mainåˆ†æ”¯çš„æ”¹åŠ¨ä¸å†²çª
            `;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ”„ main -> custom-dev åŒæ­¥å†²çªæŠ¥å‘Š',
              body: issueBody,
              labels: ['sync-conflict']
            });

      - name: æ¢å¤è‡ªå®šä¹‰æ–‡ä»¶å¹¶æäº¤
        if: env.MERGE_CONFLICT == 'false'
        run: |
          cp "$TEMP_DIR/exclude_config.bak" "$EXCLUDE_FILES_CONFIG"
          EXCLUDE_PATTERNS=()
          while IFS= read -r line || [[ -n "$line" ]]; do
            if [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]]; then
              continue
            fi
            line=$(echo "$line" | xargs)
            if [[ -n "$line" ]]; then
              EXCLUDE_PATTERNS+=("$line")
            fi
          done < "$EXCLUDE_FILES_CONFIG"
          RESTORED_COUNT=0
          for pattern in "${EXCLUDE_PATTERNS[@]}"; do
            if [[ "$pattern" == */ ]]; then
              backup_dir="$TEMP_DIR/$pattern"
              if [ -d "$backup_dir" ]; then
                find "$backup_dir" -type f | while read backup_file; do
                  rel_path=${backup_file#"$TEMP_DIR/"}
                  target_dir=$(dirname "$rel_path")
                  mkdir -p "$target_dir"
                  cp "$backup_file" "$rel_path"
                  RESTORED_COUNT=$((RESTORED_COUNT + 1))
                done
              fi
            else
              backup_pattern="$TEMP_DIR/$pattern"
              shopt -s nullglob
              backup_files=($backup_pattern)
              shopt -u nullglob
              for backup_file in "${backup_files[@]}"; do
                if [ -f "$backup_file" ]; then
                  rel_path=${backup_file#"$TEMP_DIR/"}
                  target_dir=$(dirname "$rel_path")
                  mkdir -p "$target_dir"
                  cp "$backup_file" "$rel_path"
                  RESTORED_COUNT=$((RESTORED_COUNT + 1))
                fi
              done
            fi
          done
          git add -A
          if git diff --cached --quiet; then
            echo "âœ… æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹ï¼ŒåŒæ­¥å®Œæˆ"
          else
            git commit -m "åŒæ­¥mainåˆ†æ”¯ä»£ç ï¼Œä¿ç•™custom-devåˆ†æ”¯çš„è‡ªå®šä¹‰ä¿®æ”¹"
            git push origin custom-dev
            echo "âœ… åŒæ­¥å®Œæˆ"
          fi

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          rm -rf $TEMP_DIR
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶å®Œæˆ"
      
      - name: é€šçŸ¥ç»“æœ
        run: |
          echo "âœ… æ™ºèƒ½åŒæ­¥æµç¨‹å·²å®Œæˆã€‚custom-dev åˆ†æ”¯ç°åœ¨åŒ…å« main åˆ†æ”¯çš„ä»£ç ï¼Œå¹¶ä¿ç•™äº†æ’é™¤åˆ—è¡¨ä¸­æŒ‡å®šçš„è‡ªå®šä¹‰ä¿®æ”¹ã€‚" 
