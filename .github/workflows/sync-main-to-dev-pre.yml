name: åŒæ­¥mainåˆ°devæµ‹è¯•åˆ†æ”¯(åŸºäºexcludeé…ç½®)

on:
  # åªå…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  BACKUP_DIR: '.sync-backups'
  TEMP_DIR: '.sync-temp'
  BACKUP_RETAIN_DAYS: 7
  EXCLUDE_FILE: 'sync-exclude.txt'

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: é…ç½®Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          echo "âœ… Gité…ç½®å®Œæˆ"
      
      - name: åŒæ­¥mainåˆ†æ”¯åˆ°custom-dev
        run: |
          echo "ğŸš€ å¼€å§‹åŒæ­¥mainåˆ†æ”¯åˆ°custom-devåˆ†æ”¯..."
          
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p "$BACKUP_DIR"
          mkdir -p "$TEMP_DIR"
          echo "ğŸ“ åˆ›å»ºå·¥ä½œç›®å½•å®Œæˆ"
          
          # æ£€æŸ¥ exclude æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$EXCLUDE_FILE" ]; then
            echo "âš ï¸ $EXCLUDE_FILE æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨mainåˆ†æ”¯çš„æ‰€æœ‰æ›´æ”¹"
            exit 1
          fi
          
          # é¢„å¤„ç† exclude æ–‡ä»¶ï¼Œå»é™¤æ³¨é‡Šå’Œç©ºè¡Œ
          EXCLUDE_PATTERNS=$(grep -v '^#' "$EXCLUDE_FILE" | grep -v '^[[:space:]]*$')
          if [ -z "$EXCLUDE_PATTERNS" ]; then
            echo "âš ï¸ $EXCLUDE_FILE æ–‡ä»¶ä¸ºç©ºæˆ–åªåŒ…å«æ³¨é‡Š"
            exit 1
          fi
          
          echo "ğŸ” ä½¿ç”¨ä»¥ä¸‹æ’é™¤è§„åˆ™ï¼š"
          echo "$EXCLUDE_PATTERNS"
          
          echo "ğŸ“¥ è·å–æœ€æ–°ä»£ç ..."
          git fetch origin
          git fetch origin main:main
          
          echo "ğŸ” æ£€æŸ¥custom-devåˆ†æ”¯çŠ¶æ€..."
          if ! git show-ref --verify --quiet refs/remotes/origin/custom-dev; then
            echo "âš ï¸ custom-devåˆ†æ”¯ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
            git checkout -b custom-dev
            echo "âœ… custom-devåˆ†æ”¯åˆ›å»ºæˆåŠŸ"
          else
            echo "âœ… åˆ‡æ¢åˆ°å·²å­˜åœ¨çš„custom-devåˆ†æ”¯"
            git checkout custom-dev
            echo "ğŸ”„ é‡ç½®åˆ†æ”¯åˆ°æœ€æ–°çŠ¶æ€"
            git reset --hard origin/custom-dev
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦åŒæ­¥çš„æ›´æ”¹
          CHANGES=$(git diff --name-only main)
          if [ -z "$CHANGES" ]; then
            echo "âœ¨ æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦åŒæ­¥çš„æ›´æ”¹"
            exit 0
          fi

          # åˆ›å»ºä¸´æ—¶ç›®å½•
          TEMP_PATCH_DIR="temp_patches"
          rm -rf "$TEMP_PATCH_DIR"
          mkdir -p "$TEMP_PATCH_DIR"
          
          # åˆ›å»ºå†²çªæ–‡ä»¶åˆ—è¡¨
          CONFLICT_FILES=""
          CONFLICT_SUMMARY=""
          
          # é¦–å…ˆï¼Œè·å–æ‰€æœ‰custom-devä¸­çš„ä¿®æ”¹
          echo "ğŸ“¥ å¤‡ä»½custom-devçš„ä¿®æ”¹..."
          echo "$EXCLUDE_PATTERNS" | while IFS= read -r pattern; do
            if [ -z "$pattern" ]; then
              continue
            fi
            
            if [[ "$pattern" =~ /$ ]] || [ -d "$pattern" ]; then
              # æ˜¯ç›®å½•
              if [ -d "$pattern" ]; then
                echo "ğŸ’¾ å¤‡ä»½ç›®å½•: $pattern"
                cp -r "$pattern" "$TEMP_PATCH_DIR/"
              fi
            else
              # æ˜¯æ–‡ä»¶
              if [ -f "$pattern" ]; then
                echo "ğŸ“ åˆ›å»ºè¡¥ä¸: $pattern"
                git diff main...custom-dev -- "$pattern" > "$TEMP_PATCH_DIR/$(basename "$pattern").patch"
              fi
            fi
          done
          
          # åˆ‡æ¢åˆ°mainåˆ†æ”¯çš„å†…å®¹
          echo "ğŸ”„ æ›´æ–°æ‰€æœ‰æ–‡ä»¶åˆ°mainåˆ†æ”¯ç‰ˆæœ¬..."
          git checkout main -- .
          
          # ç„¶åå¤„ç† exclude æ–‡ä»¶ä¸­çš„å†…å®¹
          echo "$EXCLUDE_PATTERNS" | while IFS= read -r pattern; do
            if [ -z "$pattern" ]; then
              continue
            fi
            
            echo "ğŸ”„ å¤„ç†: $pattern"
            
            if [[ "$pattern" =~ /$ ]] || [ -d "$pattern" ]; then
              # æ˜¯ç›®å½•
              if [ -d "$TEMP_PATCH_DIR/$(basename "$pattern")" ]; then
                echo "ğŸ“ è¿˜åŸç›®å½•: $pattern"
                rm -rf "$pattern"
                cp -r "$TEMP_PATCH_DIR/$(basename "$pattern")" "$(dirname "$pattern")/"
                
                # è®°å½•å†²çªä¿¡æ¯
                if ! git diff --quiet HEAD -- "$pattern"; then
                  CONFLICT_FILES="${CONFLICT_FILES}${pattern}\n"
                  CONFLICT_SUMMARY="${CONFLICT_SUMMARY}ç›®å½• ${pattern} æœ‰ä¿®æ”¹ï¼Œä½¿ç”¨custom-devç‰ˆæœ¬\n"
                fi
              fi
            else
              # æ˜¯æ–‡ä»¶
              if [ -f "$TEMP_PATCH_DIR/$(basename "$pattern").patch" ]; then
                echo "ğŸ“„ å¤„ç†æ–‡ä»¶: $pattern"
                
                # å°è¯•åº”ç”¨è¡¥ä¸
                if git apply --check "$TEMP_PATCH_DIR/$(basename "$pattern").patch" 2>/dev/null; then
                  echo "âœ… åº”ç”¨è¡¥ä¸åˆ°: $pattern"
                  git apply --whitespace=fix "$TEMP_PATCH_DIR/$(basename "$pattern").patch"
                  CONFLICT_FILES="${CONFLICT_FILES}${pattern}\n"
                  CONFLICT_SUMMARY="${CONFLICT_SUMMARY}æ–‡ä»¶ ${pattern} è¡¥ä¸åº”ç”¨æˆåŠŸ\n"
                else
                  echo "âš ï¸ è¡¥ä¸åº”ç”¨å¤±è´¥: $pattern"
                  # æ£€æŸ¥æ–‡ä»¶åœ¨mainåˆ†æ”¯æ˜¯å¦å­˜åœ¨
                  if git cat-file -e main:"$pattern" 2>/dev/null; then
                    echo "ğŸ“„ æ–‡ä»¶åœ¨mainåˆ†æ”¯å­˜åœ¨ï¼Œå‡†å¤‡å¤„ç†å†²çª"
                    # ç¡®ä¿ç›®å½•å­˜åœ¨
                    mkdir -p "$(dirname "$pattern")"
                    
                    # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨ä¸åŒç‰ˆæœ¬çš„å†…å®¹
                    temp_base="${TEMP_DIR}/$(basename "$pattern").base"
                    temp_main="${TEMP_DIR}/$(basename "$pattern").main"
                    temp_dev="${TEMP_DIR}/$(basename "$pattern").dev"
                    
                    # è·å–æ–‡ä»¶çš„ä¸åŒç‰ˆæœ¬
                    git show main:"$pattern" > "$temp_main"
                    git show custom-dev:"$pattern" > "$temp_dev"
                    cp "$temp_main" "$temp_base"
                    
                    # åˆ›å»ºä¸´æ—¶åˆ†æ”¯è¿›è¡Œæ–‡ä»¶åˆå¹¶
                    backup_name="${pattern}.$(date +%Y%m%d_%H%M%S).merge.bak"
                    temp_branch="temp_merge_$(date +%s)"
                    git checkout -b "$temp_branch" main
                    cp "$temp_dev" "$pattern"
                    git add "$pattern"
                    git commit -m "temp commit for merge" > /dev/null 2>&1
                    
                    # å°è¯•åˆå¹¶å¹¶æ•è·å†²çª
                    if ! git merge custom-dev -m "temp merge" > /dev/null 2>&1; then
                      # å¦‚æœæœ‰å†²çªï¼Œä¿å­˜å†²çªæ–‡ä»¶
                      if [ -f "$pattern" ]; then
                        cp "$pattern" "$backup_name"
                        echo "âœ… å·²å¤‡ä»½å†²çªæ–‡ä»¶åˆ°: $backup_name"
                      fi
                    fi
                    
                    # æ¸…ç†ä¸´æ—¶åˆ†æ”¯
                    git merge --abort > /dev/null 2>&1 || true
                    git checkout custom-dev
                    git branch -D "$temp_branch" > /dev/null 2>&1
                    
                    # ä½¿ç”¨mainç‰ˆæœ¬
                    git checkout main -- "$pattern"
                    
                    CONFLICT_FILES="${CONFLICT_FILES}${pattern}\n"
                    CONFLICT_SUMMARY="${CONFLICT_SUMMARY}æ–‡ä»¶ ${pattern} å­˜åœ¨å·®å¼‚ï¼Œå·²ç”Ÿæˆå¯¹æ¯”æ–‡ä»¶ ${backup_name}\n"
                  else
                    echo "ğŸ“„ æ–‡ä»¶åœ¨mainåˆ†æ”¯ä¸å­˜åœ¨ï¼Œä¿ç•™custom-devç‰ˆæœ¬"
                    git checkout custom-dev -- "$pattern"
                    
                    CONFLICT_FILES="${CONFLICT_FILES}${pattern}\n"
                    CONFLICT_SUMMARY="${CONFLICT_SUMMARY}æ–‡ä»¶ ${pattern} åœ¨mainåˆ†æ”¯ä¸å­˜åœ¨ï¼Œä¿ç•™custom-devç‰ˆæœ¬\n"
                  fi
                fi
              fi
            fi
          done
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf "$TEMP_PATCH_DIR"
          rm -rf "$TEMP_DIR"
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶å®Œæˆ"
          
          # æäº¤æ›´æ”¹
          # æ’é™¤ä¸´æ—¶æ–‡ä»¶å’Œç›®å½•
          git add -A
          git reset HEAD "$TEMP_DIR" "$BACKUP_DIR"
          git clean -fd "$TEMP_DIR"
          git commit -m "åŒæ­¥mainåˆ†æ”¯ä»£ç ï¼Œä¿ç•™æŒ‡å®šæ–‡ä»¶çš„custom-devç‰ˆæœ¬" || echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          git push --force origin custom-dev
          
          # å¦‚æœæœ‰å†²çªæ–‡ä»¶ï¼Œè®¾ç½®ç¯å¢ƒå˜é‡ç”¨äºåˆ›å»ºIssue
          if [ ! -z "$CONFLICT_FILES" ]; then
            echo "CONFLICT_FILES<<EOF" >> $GITHUB_ENV
            echo -e "$CONFLICT_FILES" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            echo "CONFLICT_SUMMARY<<EOF" >> $GITHUB_ENV
            echo -e "$CONFLICT_SUMMARY" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            echo "NEED_CREATE_ISSUE=true" >> $GITHUB_ENV
            
            echo "ğŸ“‹ æ£€æµ‹åˆ°ä¿®æ”¹çš„æ–‡ä»¶ï¼Œå°†åˆ›å»ºIssueæŠ¥å‘Š..."
          fi
          
          echo "âœ… åŒæ­¥å®Œæˆ"

      - name: åˆ›å»ºIssueæŠ¥å‘Š
        if: env.NEED_CREATE_ISSUE == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            console.log('ğŸ“ æ­£åœ¨åˆ›å»ºåŒæ­¥æŠ¥å‘Š...');
            
            const issueBody = `
            # main -> custom-dev åŒæ­¥æŠ¥å‘Š
            
            åœ¨åŒæ­¥è¿‡ç¨‹ä¸­ï¼Œä»¥ä¸‹æ–‡ä»¶æ ¹æ® sync-exclude.txt è¿›è¡Œäº†ç‰¹æ®Šå¤„ç†ï¼š
            
            ## å¤„ç†çš„æ–‡ä»¶åˆ—è¡¨
            \`\`\`
            ${process.env.CONFLICT_FILES}
            \`\`\`
            
            ## å¤„ç†ç»“æœ
            \`\`\`
            ${process.env.CONFLICT_SUMMARY}
            \`\`\`
            
            ## å¤„ç†è¯´æ˜
            1. æ‰€æœ‰æ–‡ä»¶å·²æ›´æ–°åˆ°mainåˆ†æ”¯ç‰ˆæœ¬
            2. å¯¹äº sync-exclude.txt ä¸­çš„ç›®å½•ï¼Œä½¿ç”¨custom-devåˆ†æ”¯çš„å®Œæ•´å†…å®¹
            3. å¯¹äº sync-exclude.txt ä¸­çš„æ–‡ä»¶ï¼š
               - å°è¯•å°†custom-devçš„ä¿®æ”¹ä½œä¸ºè¡¥ä¸åº”ç”¨åˆ°mainçš„ç‰ˆæœ¬ä¸Š
               - å¦‚æœè¡¥ä¸åº”ç”¨å¤±è´¥ï¼Œåˆ™ä½¿ç”¨custom-devçš„å®Œæ•´æ–‡ä»¶
            
            ## åç»­æ­¥éª¤
            1. æ£€æŸ¥å¤„ç†ç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸ
            2. å¦‚éœ€è°ƒæ•´ï¼Œè¯·åœ¨custom-devåˆ†æ”¯ä¸Šè¿›è¡Œä¿®æ”¹
            `;
            
            console.log('ğŸ“¤ æäº¤Issue...');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ”„ main -> custom-dev åŒæ­¥æŠ¥å‘Š',
              body: issueBody,
              labels: ['sync-conflict']
            });
            console.log('âœ… Issueåˆ›å»ºæˆåŠŸ');

      - name: Cleanup temp files
        if: always()
        run: |
          rm -rf $TEMP_DIR
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶å®Œæˆ"

      - name: Notify result
        run: |
          echo "âœ… åŒæ­¥æµç¨‹å·²å®Œæˆã€‚è¯·æ£€æŸ¥ custom-dev åˆ†æ”¯ï¼Œå¦‚æœ‰ .backup æ–‡ä»¶è¯·æ‰‹åŠ¨ diff å¹¶å¤„ç†ã€‚" 
