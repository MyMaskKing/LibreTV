name: å‘å¸ƒåŠŸèƒ½åˆ†æ”¯ç‰ˆæœ¬(custom-features)

on:
  # åªå…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  sync-to-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
      
      - name: Force sync custom-dev to custom-features
        run: |
          echo "ğŸ”„ å¼€å§‹åŒæ­¥æµç¨‹..."
          
          # è·å–æœ€æ–°ä»£ç 
          git fetch origin
          
          # æ£€æŸ¥ custom-features åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if ! git show-ref --verify --quiet refs/remotes/origin/custom-features; then
            echo "ğŸŒ± åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ custom-features..."
            git checkout -b custom-features
            git push -u origin custom-features
          fi
          
          # å¼ºåˆ¶æ›´æ–°åŠŸèƒ½åˆ†æ”¯
          echo "ğŸ”„ å¼ºåˆ¶æ›´æ–°åŠŸèƒ½åˆ†æ”¯..."
          git checkout custom-features
          git reset --hard origin/custom-dev
          git push -f origin custom-features
          
          echo "âœ… åŒæ­¥å®Œæˆï¼šå·²å°† custom-dev çš„å†…å®¹å¼ºåˆ¶åŒæ­¥åˆ°åŠŸèƒ½åˆ†æ”¯"
      
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const issueBody = `
            # åŠŸèƒ½åˆ†æ”¯åŒæ­¥å¤±è´¥
            
            åœ¨å°†å¼€å‘åˆ†æ”¯åŒæ­¥åˆ°åŠŸèƒ½åˆ†æ”¯æ—¶å‘ç”Ÿé”™è¯¯ã€‚
            
            ## è¯¦ç»†ä¿¡æ¯
            - å·¥ä½œæµè¿è¡Œ: [æŸ¥çœ‹è¿è¡Œè®°å½•](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - æ—¶é—´: ${new Date().toISOString()}
            
            ## åˆ†æ”¯ä¿¡æ¯
            - æºåˆ†æ”¯: \`custom-dev\` (å¼€å‘åˆ†æ”¯)
            - ç›®æ ‡åˆ†æ”¯: \`custom-features\` (åŠŸèƒ½åˆ†æ”¯)
            
            ## æ³¨æ„äº‹é¡¹
            è¿™æ˜¯å¼ºåˆ¶åŒæ­¥æ“ä½œï¼Œå¦‚æœåŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š
            1. æ˜¯å¦æœ‰è¶³å¤Ÿçš„æƒé™
            2. åˆ†æ”¯ä¿æŠ¤è§„åˆ™æ˜¯å¦å…è®¸å¼ºåˆ¶æ¨é€
            3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ”„ åŠŸèƒ½åˆ†æ”¯åŒæ­¥å¤±è´¥',
              body: issueBody,
              labels: ['sync-failed', 'needs-attention']
            });
      
      - name: Notify success
        if: success()
        run: |
          echo "âœ… åŠŸèƒ½åˆ†æ”¯åŒæ­¥æˆåŠŸ"
          echo "custom-dev -> custom-features" 