name: åŒæ­¥mainåˆ°devæµ‹è¯•åˆ†æ”¯(åŸºäºmerge-base)

on:
  # åªå…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  BACKUP_DIR: '.sync-backups'
  TEMP_DIR: '.sync-temp'
  BACKUP_RETAIN_DAYS: 7

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: é…ç½®Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          echo "âœ… Gité…ç½®å®Œæˆ"
      
      - name: åŒæ­¥mainåˆ†æ”¯åˆ°custom-dev
        run: |
          echo "ğŸš€ å¼€å§‹åŒæ­¥mainåˆ†æ”¯åˆ°custom-devåˆ†æ”¯..."
          
          echo "ğŸ“¥ è·å–æœ€æ–°ä»£ç ..."
          git fetch origin
          git fetch origin main:main
          
          echo "ğŸ” æ£€æŸ¥custom-devåˆ†æ”¯çŠ¶æ€..."
          if ! git show-ref --verify --quiet refs/remotes/origin/custom-dev; then
            echo "âš ï¸ custom-devåˆ†æ”¯ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
            git checkout -b custom-dev
            echo "âœ… custom-devåˆ†æ”¯åˆ›å»ºæˆåŠŸ"
          else
            echo "âœ… åˆ‡æ¢åˆ°å·²å­˜åœ¨çš„custom-devåˆ†æ”¯"
            git checkout custom-dev
            echo "ğŸ”„ é‡ç½®åˆ†æ”¯åˆ°æœ€æ–°çŠ¶æ€"
            git reset --hard origin/custom-dev
          fi

          echo "ğŸ§¹ æ¸…ç†å¯èƒ½å­˜åœ¨çš„åˆå¹¶çŠ¶æ€..."
          git merge --abort || true

          echo "ğŸ”„ å°è¯•åˆå¹¶mainåˆ†æ”¯..."
          if git merge --squash main --no-commit; then
            echo "ğŸ”„ æ’é™¤ workflow æ–‡ä»¶..."
            git restore --staged .github/workflows/
            git restore .github/workflows/
            
            echo "âœ… åˆå¹¶æˆåŠŸ"
            git add -A
            git commit -m "åŒæ­¥mainåˆ†æ”¯ä»£ç "
            git push --force origin custom-dev
            exit 0
          fi

          echo "æ£€æµ‹åˆ°å†²çªï¼Œå¼€å§‹æ™ºèƒ½å¤„ç†..."
          
          # è·å–ä»“åº“æ ¹ç›®å½•è·¯å¾„å’Œå¤‡ä»½ç›®å½•
          REPO_ROOT=$(pwd)
          echo -e "å½“å‰æ‰€å¤„ç›®å½•ï¼š$REPO_ROOT"
          BACKUP_ROOT="../backup_files"
          
          # åˆ›å»ºå¤‡ä»½æ ¹ç›®å½•
          rm -rf "$BACKUP_ROOT"
          mkdir -p "$BACKUP_ROOT"
          
          # è·å–å…±åŒç¥–å…ˆ
          base=$(git merge-base main custom-dev)
          
          # è·å–æ‰€æœ‰å†²çªæ–‡ä»¶
          CONFLICT_FILES=$(git diff --name-only --diff-filter=U)
          
          # è¿‡æ»¤æ‰ workflow æ–‡ä»¶
          FILTERED_CONFLICT_FILES=""
          while IFS= read -r file; do
            if [[ ! "$file" =~ ^\.github/workflows/ ]]; then
              FILTERED_CONFLICT_FILES="${FILTERED_CONFLICT_FILES}${file}\n"
            fi
          done <<< "$CONFLICT_FILES"
          
          echo "ğŸ“ å‘ç°ä»¥ä¸‹å†²çªæ–‡ä»¶ï¼ˆå·²æ’é™¤workflowæ–‡ä»¶ï¼‰ï¼š"
          echo -e "$FILTERED_CONFLICT_FILES"
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨å¤‡ä»½æ–‡ä»¶åˆ—è¡¨
          BACKUP_FILES_LIST="/tmp/backup_files_list.txt"
          > "$BACKUP_FILES_LIST"  # æ¸…ç©ºæ–‡ä»¶
          
          # ä¿®å¤ï¼šé€è¡Œå¤„ç†å†²çªæ–‡ä»¶
          echo -e "$FILTERED_CONFLICT_FILES" | while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi
            
            echo "ğŸ”„ å¤„ç†æ–‡ä»¶: $file"
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f "$file" ]; then
              echo "âš ï¸ è­¦å‘Šï¼šæ–‡ä»¶ $file ä¸å­˜åœ¨ï¼Œè·³è¿‡"
              continue
            fi
            
            # æ£€æŸ¥ custom-dev æ˜¯å¦ä¿®æ”¹äº†è¿™ä¸ªæ–‡ä»¶
            if git diff --quiet $base HEAD -- "$file"; then
              echo "âœ¨ $file åœ¨custom-devä¸­æœªä¿®æ”¹ï¼Œè‡ªåŠ¨ä½¿ç”¨mainçš„ç‰ˆæœ¬"
              git checkout --theirs "$file"
              git add "$file"
              continue
            fi
            
            echo "âš ï¸ $file åœ¨custom-devä¸­æœ‰ä¿®æ”¹ï¼Œåˆ›å»ºå¤‡ä»½..."
            # åœ¨å¤‡ä»½ç›®å½•ä¸­åˆ›å»ºå¯¹åº”çš„ç›®å½•ç»“æ„
            file_dir=$(dirname "$file")
            backup_dir="$BACKUP_ROOT/$file_dir"
            mkdir -p "$backup_dir"
            
            # åˆ›å»ºå¤‡ä»½æ–‡ä»¶
            backup_name="$(basename "$file").$(date +%Y%m%d_%H%M%S).backup"
            backup_file="$backup_dir/$backup_name"
            cp "$file" "$backup_file" || echo "âš ï¸ æ— æ³•åˆ›å»ºå¤‡ä»½æ–‡ä»¶: $backup_file"
            
            if [ -f "$backup_file" ]; then
              echo "âœ… å¤‡ä»½æ–‡ä»¶åˆ›å»ºæˆåŠŸ: $backup_file"
              # å°†å¤‡ä»½æ–‡ä»¶è·¯å¾„æ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼Œä¿ç•™ç›¸å¯¹ç›®å½•ç»“æ„
              backup_relative_path="${file_dir}/${backup_name}"
              # æ¸…ç†è·¯å¾„ä¸­çš„å¤šä½™çš„ ./ 
              backup_relative_path=$(echo "$backup_relative_path" | sed 's|^\./||' | sed 's|/\./|/|g')
              echo "$backup_relative_path" >> "$BACKUP_FILES_LIST"
              
              echo "ğŸ“¥ ä½¿ç”¨mainåˆ†æ”¯ç‰ˆæœ¬..."
              git checkout main -- "$file"
              git add "$file"
            fi
          done
          
          # è¯»å–å¤‡ä»½æ–‡ä»¶åˆ—è¡¨
          BACKUP_FILES=""
          if [ -f "$BACKUP_FILES_LIST" ]; then
            BACKUP_FILES=$(cat "$BACKUP_FILES_LIST")
          fi
          
          # æ¸…ç†å½“å‰çŠ¶æ€
          git reset --hard HEAD
          git clean -f -d
          
          # è·å– main åˆ†æ”¯çš„æ‰€æœ‰æ›´æ”¹
          echo "ğŸ“¥ åŒæ­¥ main åˆ†æ”¯çš„æ‰€æœ‰æ›´æ”¹..."
          git checkout main -- .
          
          # æ¢å¤ workflow æ–‡ä»¶
          echo "ğŸ”„ æ¢å¤åŸæœ‰çš„workflowæ–‡ä»¶..."
          rm -rf .github/workflows/*  # åˆ é™¤ä»mainåˆ†æ”¯è·å–çš„workflowæ–‡ä»¶
          git checkout custom-dev -- .github/workflows/  # æ¢å¤custom-devåˆ†æ”¯çš„workflowæ–‡ä»¶
          
          # æ¢å¤å¤‡ä»½æ–‡ä»¶
          echo "ğŸ“¥ æ¢å¤å¤‡ä»½æ–‡ä»¶..."
          if [ -d "$BACKUP_ROOT" ]; then
            cp -r "$BACKUP_ROOT"/* .
            # æ¸…ç†å¤‡ä»½æ–‡ä»¶å¤¹
            echo "ğŸ§¹ æ¸…ç†å¤‡ä»½æ–‡ä»¶å¤¹..."
            rm -rf "$BACKUP_ROOT"
          fi
          
          # æäº¤æ‰€æœ‰æ›´æ”¹
          echo "âš ï¸ æäº¤åŒæ­¥çš„mainåˆ†æ”¯ä»£ç å’Œå†²çªæ–‡ä»¶å¤‡ä»½"
          git add -A
          git commit -m "åŒæ­¥mainåˆ†æ”¯ä»£ç ï¼Œå¹¶ä¿å­˜å†²çªæ–‡ä»¶å¤‡ä»½" || echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          git push --force origin custom-dev
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ç”¨äºåˆ›å»ºIssue
          if [ ! -z "$BACKUP_FILES" ]; then
            echo "BACKUP_FILES<<EOF" >> $GITHUB_ENV
            echo "$BACKUP_FILES" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            echo "CONFLICT_FILES<<EOF" >> $GITHUB_ENV
            echo -e "$FILTERED_CONFLICT_FILES" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            # è®¾ç½®æ ‡å¿—ï¼Œè¡¨ç¤ºéœ€è¦åˆ›å»ºIssue
            echo "NEED_CREATE_ISSUE=true" >> $GITHUB_ENV
            
            echo "ğŸ“‹ æ£€æµ‹åˆ°å†²çªæ–‡ä»¶ï¼Œå°†åˆ›å»ºIssueæŠ¥å‘Šå†²çªæƒ…å†µ..."
          else
            echo "âœ… æ‰€æœ‰å†²çªå·²è‡ªåŠ¨å¤„ç†"
          fi

      - name: åˆ›å»ºIssueæŠ¥å‘Š
        if: env.NEED_CREATE_ISSUE == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            console.log('ğŸ“ æ­£åœ¨åˆ›å»ºåŒæ­¥å†²çªæŠ¥å‘Š...');
            
            const issueBody = `
            # main -> custom-dev åŒæ­¥å†²çªæŠ¥å‘Š
            
            åœ¨åŒæ­¥è¿‡ç¨‹ä¸­å‘ç°ä»¥ä¸‹æ–‡ä»¶å­˜åœ¨å†²çªï¼Œå·²è‡ªåŠ¨ä½¿ç”¨mainåˆ†æ”¯çš„ä»£ç å¹¶å¤‡ä»½åŸæ–‡ä»¶ã€‚
            
            ## å†²çªæ–‡ä»¶åˆ—è¡¨
            \`\`\`
            ${process.env.CONFLICT_FILES}
            \`\`\`
            
            ## å¤‡ä»½æ–‡ä»¶
            å·²åœ¨æ¯ä¸ªå†²çªæ–‡ä»¶çš„åŒç›®å½•ä¸‹åˆ›å»ºå¤‡ä»½æ–‡ä»¶ï¼š
            \`\`\`
            ${process.env.BACKUP_FILES}
            \`\`\`
            
            ## å¤„ç†è¯´æ˜
            1. æ‰€æœ‰å†²çªæ–‡ä»¶å·²ä½¿ç”¨mainåˆ†æ”¯çš„ç‰ˆæœ¬
            2. custom-devåˆ†æ”¯çš„åŸå§‹ä»£ç å·²åœ¨åŒç›®å½•ä¸‹å¤‡ä»½
            3. å¦‚éœ€æ¢å¤æˆ–åˆå¹¶è‡ªå®šä¹‰ä»£ç ï¼Œè¯·å‚è€ƒå¤‡ä»½æ–‡ä»¶
            
            ## æ‰‹åŠ¨å¤„ç†æ­¥éª¤
            1. æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å†…å®¹
            2. å¦‚éœ€ä¿®æ”¹ï¼Œè¯·åœ¨custom-devåˆ†æ”¯ä¸Šè¿›è¡Œæ›´æ”¹
            3. ç¡®ä¿æ›´æ”¹åçš„ä»£ç ä¸mainåˆ†æ”¯çš„æ”¹åŠ¨ä¸å†²çª
            `;
            
            console.log('ğŸ“¤ æäº¤Issue...');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ”„ main -> custom-dev åŒæ­¥å†²çªæŠ¥å‘Š',
              body: issueBody,
              labels: ['sync-conflict']
            });
            console.log('âœ… Issueåˆ›å»ºæˆåŠŸ');

      - name: Cleanup temp files
        if: always()
        run: |
          rm -rf $TEMP_DIR
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶å®Œæˆ"
      
      - name: Notify result
        run: |
          echo "âœ… åŒæ­¥æµç¨‹å·²å®Œæˆã€‚è¯·æ£€æŸ¥ custom-dev åˆ†æ”¯ï¼Œå¦‚æœ‰ .backup æ–‡ä»¶è¯·æ‰‹åŠ¨ diff å¹¶å¤„ç†ã€‚" 
